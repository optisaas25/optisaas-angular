<!-- PD Measurement Modal -->
<div class="camera-modal" *ngIf="showPDModal" (click)="closePDMeasurement()">
    <div class="modal-content pd-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Mesure Ã‰cart Pupillaire (EP)</h3>
            <button type="button" class="btn-close" (click)="closePDMeasurement()">Ã—</button>
        </div>

        <div class="modal-body">
            <!-- Mode Selection -->
            <div class="pd-mode-selector" *ngIf="pdStep === 'capture'">
                <label [class.active]="pdMode === 'sticker'">
                    <input type="radio" name="pdMode" value="sticker" [checked]="pdMode === 'sticker'"
                        (change)="setPDMode('sticker')">
                    <span>Mode Sticker (1cm)</span>
                </label>
                <label [class.active]="pdMode === 'bridge'">
                    <input type="radio" name="pdMode" value="bridge" [checked]="pdMode === 'bridge'"
                        (change)="setPDMode('bridge')">
                    <span>Mode Pont Monture</span>
                </label>
            </div>

            <!-- Step 1: Capture -->
            <div class="camera-container" *ngIf="pdStep === 'capture'">
                <video #pdVideoElement autoplay playsinline></video>
                <div class="overlay-guide" [class.sticker-guide]="pdMode === 'sticker'"
                    [class.glasses-guide]="pdMode === 'bridge'"></div>
            </div>

            <!-- Step 2 & 3: Calibration & Measurement -->
            <div class="canvas-container" *ngIf="pdStep !== 'capture'">
                <canvas #pdCanvasElement (click)="onPDCanvasClick($event)"></canvas>

                <div class="instructions-overlay">
                    <p *ngIf="pdStep === 'calibration' && pdMode === 'sticker'">
                        Cliquez sur les <strong>2 coins supÃ©rieurs</strong> du sticker 1cm.
                    </p>
                    <p *ngIf="pdStep === 'calibration' && pdMode === 'bridge'">
                        Cliquez sur les <strong>2 extrÃ©mitÃ©s</strong> du pont de la monture.
                    </p>
                    <p *ngIf="pdStep === 'measurement'">
                        Cliquez successivement sur : <br>
                        <span [class.done]="markers.pupilRight.x !== 0">1. Pupille Droite (OD)</span> &rarr;
                        <span [class.done]="markers.bridge.x !== 0">2. Centre Pont</span> &rarr;
                        <span [class.done]="markers.pupilLeft.x !== 0">3. Pupille Gauche (OG)</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <div class="bridge-input" *ngIf="pdMode === 'bridge' && pdStep === 'calibration'">
                <label>Largeur Pont (mm):</label>
                <div class="input-group">
                    <input type="number" [(ngModel)]="bridgeWidthMm" class="form-control" style="width: 80px;">
                    <button type="button" class="btn-secondary btn-sm" (click)="importBridgeFromStock()"
                        title="Importer depuis la fiche monture">
                        ðŸ“¦ Importer Stock
                    </button>
                </div>
            </div>

            <button type="button" class="btn-secondary" (click)="closePDMeasurement()">Annuler</button>

            <button type="button" class="btn-primary" *ngIf="pdStep === 'capture'" (click)="capturePDPhoto()">
                ðŸ“· Capturer
            </button>

            <button type="button" class="btn-primary" *ngIf="pdStep === 'calibration'" (click)="validateCalibration()">
                Valider Calibration
            </button>

            <button type="button" class="btn-success" *ngIf="pdStep === 'measurement' && pdValues.total > 0"
                (click)="applyPDValues()">
                âœ“ Valider Mesures ({{pdValues.total}} mm)
            </button>
        </div>
    </div>
</div>