<div class="container mx-auto p-6">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Rapport de Bénéfice Réel</h1>

        <div class="flex gap-4 bg-white p-2 rounded shadow">
            <mat-form-field appearance="outline" class="w-40">
                <mat-label>Du</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" (dateChange)="onDateChange()">
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-40">
                <mat-label>Au</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" (dateChange)="onDateChange()">
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>

            <button mat-icon-button color="primary" (click)="loadData()" [disabled]="loading">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>
    </div>

    <div *ngIf="loading" class="text-center py-10">
        <p>Chargement des données...</p>
    </div>

    <div *ngIf="!loading && data" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Revenue Card -->
        <mat-card class="bg-blue-50">
            <mat-card-header>
                <mat-card-title class="text-blue-700">Revenu (HT)</mat-card-title>
            </mat-card-header>
            <mat-card-content class="pt-4">
                <div class="text-3xl font-bold text-blue-900">{{ data.revenue | number:'1.2-2' }} DH</div>
                <div class="text-sm text-blue-600">Total Facturé (Hors Avoirs)</div>
            </mat-card-content>
        </mat-card>

        <!-- COGS Card -->
        <mat-card class="bg-orange-50">
            <mat-card-header>
                <mat-card-title class="text-orange-700">Coût d'Achat (COGS)</mat-card-title>
            </mat-card-header>
            <mat-card-content class="pt-4">
                <div class="text-3xl font-bold text-orange-900">{{ data.cogs | number:'1.2-2' }} DH</div>
                <div class="text-sm text-orange-600">Valeur d'achat des produits vendus</div>
            </mat-card-content>
        </mat-card>

        <!-- Expenses Card -->
        <mat-card class="bg-red-50">
            <mat-card-header>
                <mat-card-title class="text-red-700">Dépenses</mat-card-title>
            </mat-card-header>
            <mat-card-content class="pt-4">
                <div class="text-3xl font-bold text-red-900">{{ data.expenses | number:'1.2-2' }} DH</div>
                <div class="text-sm text-red-600">Charges Opérationnelles</div>
            </mat-card-content>
        </mat-card>

        <!-- Net Profit Card -->
        <mat-card [ngClass]="{'bg-green-50': data.netProfit >= 0, 'bg-red-100': data.netProfit < 0}">
            <mat-card-header>
                <mat-card-title [ngClass]="{'text-green-700': data.netProfit >= 0, 'text-red-700': data.netProfit < 0}">
                    Bénéfice Net
                </mat-card-title>
            </mat-card-header>
            <mat-card-content class="pt-4">
                <div class="text-3xl font-bold"
                    [ngClass]="{'text-green-900': data.netProfit >= 0, 'text-red-900': data.netProfit < 0}">
                    {{ data.netProfit | number:'1.2-2' }} DH
                </div>
                <div class="text-sm font-medium">Marges: {{ data.analysis.marginRate | number:'1.1-1' }}%</div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Chart Section -->
    <mat-card *ngIf="!loading && data">
        <mat-card-content>
            <div style="height: 400px;">
                <canvas id="profitChart"></canvas>
            </div>
        </mat-card-content>
    </mat-card>
</div>