<div class="caisse-live-container" *ngIf="resume; else loadingTpl">
    <!-- Header -->
    <div class="header">
        <div class="title-section">
            <h1>Caisse : {{ resume.journee.caisse.nom }}</h1>
            <span class="subtitle">{{ resume.journee.centre.nom }} | Ouverte par {{ resume.journee.caissier }}</span>
        </div>

        <div class="actions" *ngIf="resume.journee.statut === 'OUVERTE'">
            <button mat-raised-button color="warn" (click)="closeCaisse()">
                <mat-icon>lock</mat-icon> CLÔTURER LA CAISSE
            </button>
        </div>
        <div class="actions" *ngIf="resume.journee.statut === 'FERMEE'">
            <mat-chip-listbox>
                <mat-chip color="warn">SESSION CLÔTURÉE</mat-chip>
            </mat-chip-listbox>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <!-- 1. Recettes (Green) -->
        <mat-card class="summary-card green-border">
            <mat-card-content>
                <div class="label">Recettes de la Journée</div>
                <div class="value">{{ resume.totalRecettes | number:'1.2-2' }} DH</div>
                <div class="card-details">
                    <div class="detail-row">
                        <span>Espèces:</span>
                        <b class="text-green-600">{{ resume.recettesDetails.espaces | number:'1.2-2' }} DH</b>
                    </div>
                    <div class="detail-row">
                        <span>Carte:</span>
                        <div class="flex items-center gap-2">
                            <span *ngIf="resume.recettesDetails.carteCount > 0"
                                class="text-xs bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded font-bold">
                                {{ resume.recettesDetails.carteCount }}
                            </span>
                            <b class="text-blue-600">{{ resume.recettesDetails.carte | number:'1.2-2' }} DH</b>
                        </div>
                    </div>
                    <div class="detail-row">
                        <span>Chèque/Autre:</span>
                        <div class="flex items-center gap-2">
                            <span *ngIf="resume.recettesDetails.chequeCount > 0"
                                class="text-xs bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded font-bold">
                                {{ resume.recettesDetails.chequeCount }}
                            </span>
                            <b>{{ resume.recettesDetails.cheque | number:'1.2-2' }} DH</b>
                        </div>
                    </div>
                    <div class="detail-row">
                        <span class="text-orange-600">En coffre (Chèques/LCN):</span>
                        <div class="flex items-center gap-2">
                            <span *ngIf="resume.recettesDetails.enCoffreCount > 0"
                                class="text-xs bg-orange-100 text-orange-800 px-1.5 py-0.5 rounded font-bold">
                                {{ resume.recettesDetails.enCoffreCount }}
                            </span>
                            <b class="text-orange-600">{{ resume.recettesDetails.enCoffre | number:'1.2-2' }} DH</b>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- 2. Décaissements (Orange) -->
        <mat-card class="summary-card orange-border">
            <mat-card-content>
                <div class="label">Décaissements du jour</div>
                <div class="value text-orange-600">{{ resume.totalDepenses | number:'1.2-2' }} DH</div>
                <div class="card-details">
                    <div class="detail-row">
                        <span>Dépenses réglées:</span>
                        <b>{{ resume.totalDepenses | number:'1.2-2' }} DH</b>
                    </div>
                    <div class="detail-row" *ngIf="resume.journee.caisse.type === 'PRINCIPALE'">
                        <span>Vers dépenses:</span>
                        <b>{{ resume.totalInterne | number:'1.2-2' }} DH</b>
                    </div>
                    <div class="detail-row" *ngIf="resume.journee.caisse.type === 'DEPENSES'">
                        <span>Entrées du jour:</span>
                        <b>{{ resume.totalInterne | number:'1.2-2' }} DH</b>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- 3. Solde Réel (Blue) -->
        <mat-card class="summary-card blue-border">
            <mat-card-content>
                <div class="label">Solde Réel (Cash-Flow)</div>
                <div class="value">{{ getSolde() | number:'1.2-2' }} DH</div>
                <div class="card-details">
                    <div class="detail-row">
                        <span>Fond initial:</span>
                        <b>{{ resume.fondInitial | number:'1.2-2' }} DH</b>
                    </div>
                    <div class="detail-row">
                        <span>Flux Net Espèces:</span>
                        <b>{{ (getSolde() - resume.fondInitial) | number:'1.2-2' }} DH</b>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

    </div>

    <!-- Quick Actions (Hidden if Closed) -->
    <div class="quick-actions" *ngIf="resume.journee.statut === 'OUVERTE'">
        <button mat-flat-button color="accent" class="action-btn" *ngIf="resume.journee.caisse.type === 'PRINCIPALE'"
            (click)="openOperationDialog(OperationType.DECAISSEMENT)">
            <mat-icon>remove_circle</mat-icon> DÉCAISSER
        </button>

        <button mat-flat-button color="warn" class="action-btn" *ngIf="resume.journee.caisse.type === 'PRINCIPALE'"
            (click)="openTransferDialog()">
            <mat-icon>swap_horiz</mat-icon> ALIMENTER DÉPENSES
        </button>
    </div>

    <!-- Operations Table -->
    <mat-card class="operations-card">
        <mat-card-header>
            <mat-card-title>Journal des opérations</mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <table mat-table [dataSource]="operations" class="full-width-table">
                <!-- Date Column -->
                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef> Date Opération </th>
                    <td mat-cell *matCellDef="let op">
                        <span class="text-xs text-gray-500">{{ op.createdAt | date:'dd/MM' }}</span>
                        <span class="font-medium ml-1">{{ op.createdAt | date:'HH:mm' }}</span>
                    </td>
                </ng-container>

                <!-- Type Column -->
                <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef> Type </th>
                    <td mat-cell *matCellDef="let op">
                        <span class="type-badge" [ngClass]="op.type">
                            {{ op.type === 'ENCAISSEMENT' ? 'Encaissement' : 'Décaissement' }}
                        </span>
                        <span *ngIf="op.typeOperation === 'INTERNE'" class="monitor-badge">INT</span>
                    </td>
                </ng-container>

                <!-- Montant Column -->
                <ng-container matColumnDef="montant">
                    <th mat-header-cell *matHeaderCellDef> Montant </th>
                    <td mat-cell *matCellDef="let op" [class.negative]="op.type === 'DECAISSEMENT'">
                        {{ op.type === 'DECAISSEMENT' ? '-' : '+' }}
                        {{ op.montant | number:'1.2-2' }} DH
                    </td>
                </ng-container>

                <!-- Moyen Column -->
                <ng-container matColumnDef="moyen">
                    <th mat-header-cell *matHeaderCellDef> Moyen </th>
                    <td mat-cell *matCellDef="let op"> {{ op.moyenPaiement }} </td>
                </ng-container>

                <!-- Reference Column -->
                <ng-container matColumnDef="reference">
                    <th mat-header-cell *matHeaderCellDef> Référence </th>
                    <td mat-cell *matCellDef="let op">
                        <span *ngIf="op.facture?.numero">Fac: {{ op.facture?.numero }}</span>
                        <span *ngIf="op.reference">{{ op.reference }}</span>
                    </td>
                </ng-container>

                <!-- Motif Column -->
                <ng-container matColumnDef="motif">
                    <th mat-header-cell *matHeaderCellDef> Motif </th>
                    <td mat-cell *matCellDef="let op"> {{ op.motif || '-' }} </td>
                </ng-container>

                <!-- Utilisateur Column -->
                <ng-container matColumnDef="utilisateur">
                    <th mat-header-cell *matHeaderCellDef> Utilisateur </th>
                    <td mat-cell *matCellDef="let op"> {{ op.utilisateur }} </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> {{ resume.journee.statut === 'OUVERTE' ? 'Actions' : '' }}
                    </th>
                    <td mat-cell *matCellDef="let op">
                        <button mat-icon-button color="warn" (click)="deleteOperation(op)"
                            *ngIf="resume.journee.statut === 'OUVERTE'">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                <!-- Empty State -->
                <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell" colspan="8" style="text-align: center; padding: 24px;">
                        Aucune opération enregistrée pour le moment
                    </td>
                </tr>
            </table>
        </mat-card-content>
    </mat-card>
</div>

<ng-template #loadingTpl>
    <div class="loading-container" *ngIf="!errorLoading; else errorTpl">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Chargement de la caisse...</p>
    </div>
</ng-template>

<ng-template #errorTpl>
    <div class="error-container" style="text-align: center; padding: 40px;">
        <mat-icon color="warn" style="font-size: 48px; width: 48px; height: 48px;">error_outline</mat-icon>
        <h2>Impossible de charger la caisse</h2>
        <p>Veuillez rafraîchir la page ou contacter l'administrateur.</p>
        <button mat-flat-button color="primary" (click)="loadData()">RÉESSAYER</button>
    </div>
</ng-template>