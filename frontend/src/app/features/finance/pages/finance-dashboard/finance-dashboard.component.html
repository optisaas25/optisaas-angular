<div class="container">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Trésorerie & Plafonds</h1>
        <div class="flex items-center gap-3">
            <mat-form-field appearance="outline" class="!mb-0 !pb-0 !w-40 dense-form-field">
                <mat-label>Mois</mat-label>
                <mat-select [(ngModel)]="currentMonth" (selectionChange)="loadData()">
                    <mat-option *ngFor="let m of months" [value]="m.value">{{ m.label }}</mat-option>
                </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="!mb-0 !pb-0 !w-32 dense-form-field">
                <mat-label>Année</mat-label>
                <mat-select [(ngModel)]="currentYear" (selectionChange)="loadData()">
                    <mat-option *ngFor="let y of years" [value]="y">{{ y }}</mat-option>
                </mat-select>
            </mat-form-field>
            <button mat-icon-button class="text-gray-500" (click)="loadData()" matTooltip="Actualiser">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>
    </div>

    <div *ngIf="loading" class="text-center p-10">Chargement des données...</div>

    <div *ngIf="summary && !loading">
        <div class="grid">
            <!-- Recettes -->
            <mat-card class="card-metric border-l-4 border-green-500">
                <div class="metric-label flex items-center justify-center gap-1">
                    Recettes du Mois
                    <mat-icon class="!text-xs text-gray-400"
                        matTooltip="Total des paiements (Cash + Chèques) datés de ce mois.">help_outline</mat-icon>
                </div>
                <div class="metric-value text-green-600">{{ summary.totalIncoming | number:'1.2-2' }} DH</div>
                <div class="flex flex-col gap-1 text-sm text-gray-500 font-medium">
                    <div class="flex justify-between px-4">
                        <span>Espèces:</span>
                        <span class="text-green-700">{{ summary.incomingCash | number:'1.2-2' }} DH</span>
                    </div>
                    <div class="flex justify-between px-4">
                        <span>Carte:</span>
                        <span class="text-blue-600">{{ summary.incomingCard | number:'1.2-2' }} DH</span>
                    </div>
                    <div class="flex justify-between px-4"
                        *ngIf="(summary.totalIncomingCashed - summary.incomingCash - summary.incomingCard) > 1">
                        <span>Chèque/Autre:</span>
                        <span class="text-gray-700">{{ (summary.totalIncomingCashed - summary.incomingCash -
                            summary.incomingCard) | number:'1.2-2' }} DH</span>
                    </div>
                    <div class="flex justify-between px-4 pt-1 border-t border-gray-100 mt-1">
                        <span>En coffre (Chèques/LCN):</span>
                        <span class="text-orange-600">{{ summary.totalIncomingPending | number:'1.2-2' }} DH</span>
                    </div>
                </div>
            </mat-card>

            <!-- Dépenses -->
            <mat-card class="card-metric border-l-4 border-orange-500">
                <div class="metric-label flex items-center justify-center gap-1">
                    Dépenses du Mois
                    <mat-icon class="!text-xs text-gray-400"
                        matTooltip="Total des charges et échéances fournisseurs prévues ce mois.">help_outline</mat-icon>
                </div>
                <div class="metric-value text-orange-600">{{ summary.totalExpenses | number:'1.2-2' }} DH</div>
                <div class="flex flex-col gap-1 text-sm text-gray-500 font-medium">
                    <div class="flex justify-between px-4">
                        <span>Réglé:</span>
                        <span class="text-green-700">{{ summary.totalExpensesCashed | number:'1.2-2' }} DH</span>
                    </div>
                    <div class="flex justify-between px-4">
                        <span>À débiter (Chèques/LCN):</span>
                        <span class="text-orange-600">{{ summary.totalOutgoingPending | number:'1.2-2' }} DH</span>
                    </div>
                </div>
            </mat-card>

            <!-- Solde -->
            <mat-card class="card-metric border-l-4"
                [ngClass]="summary.balanceReal >= 0 ? 'border-blue-500' : 'border-red-500'">
                <div class="metric-label flex items-center justify-center gap-1">
                    Solde Réel (Cash-Flow)
                    <mat-icon class="!text-xs text-gray-400"
                        matTooltip="Différence entre l'argent réellement encaissé et l'argent réellement payé ce mois.">help_outline</mat-icon>
                </div>
                <div class="metric-value" [ngClass]="summary.balanceReal >= 0 ? 'text-blue-600' : 'text-red-600'">
                    {{ summary.balanceReal | number:'1.2-2' }} DH
                </div>
                <div class="text-sm text-gray-500">
                    Projeté (fin de mois): <span class="font-bold">{{ summary.balance | number:'1.2-2' }} DH</span>
                </div>
            </mat-card>

            <!-- Plafond -->
            <mat-card class="card-metric border-l-4 border-purple-500">
                <div class="metric-label">Contrôle Plafond Dépenses</div>
                <div class="metric-value" [ngClass]="percentageUsed > 100 ? 'text-red-500' : 'text-purple-600'">
                    {{ summary.totalExpenses | number:'1.2-2' }} DH
                </div>
                <div class="threshold-container px-4">
                    <div class="threshold-label">
                        <span>{{ percentageUsed.toFixed(1) }}% du plafond</span>
                        <div class="flex items-center gap-2">
                            <span *ngIf="!editingThreshold">Max: {{ monthlyThreshold | number }} DH</span>
                            <input *ngIf="editingThreshold" type="number" [(ngModel)]="newThreshold"
                                class="w-16 border rounded px-1 text-xs" (keyup.enter)="saveThreshold()">
                            <button mat-icon-button class="!w-4 !h-4"
                                (click)="editingThreshold ? saveThreshold() : toggleEditThreshold()">
                                <mat-icon class="!text-[12px]">{{ editingThreshold ? 'check' : 'edit' }}</mat-icon>
                            </button>
                        </div>
                    </div>
                    <mat-progress-bar [mode]="'determinate'" [value]="percentageUsed"
                        [color]="thresholdColor"></mat-progress-bar>
                </div>
            </mat-card>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Dépenses par Catégorie -->
            <mat-card class="!rounded-2xl !shadow-sm !border-none overflow-hidden h-full">
                <mat-card-header class="!px-6 !pt-6">
                    <mat-card-title class="!text-xl !font-bold flex items-center gap-2">
                        <mat-icon class="text-indigo-500">pie_chart</mat-icon>
                        Répartition des Dépenses
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content class="!p-6">
                    <div class="flex flex-col gap-4" *ngIf="summary?.categories?.length; else noData">
                        <div *ngFor="let cat of summary?.categories; let i = index" class="w-full">
                            <div class="flex justify-between items-end mb-1">
                                <span class="font-medium text-sm text-gray-700 flex items-center gap-2">
                                    <mat-icon class="text-xs scale-75"
                                        [style.color]="chartColors[i % chartColors.length]">circle</mat-icon>
                                    {{ cat.name }}
                                </span>
                                <span class="font-bold text-sm">{{ cat.value | number:'1.0-0' }} DH</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                <div class="h-2.5 rounded-full"
                                    [style.width.%]="(cat.value / summary.totalExpenses) * 100"
                                    [style.background-color]="chartColors[i % chartColors.length]">
                                </div>
                            </div>
                        </div>
                    </div>
                    <ng-template #noData>
                        <div class="flex flex-col items-center justify-center h-[300px] text-gray-400">
                            <mat-icon style="font-size: 48px; width: 48px; height: 48px;">pie_chart_outline</mat-icon>
                            <p class="mt-2 text-sm italic">Aucune dépense pour cette période</p>
                        </div>
                    </ng-template>
                </mat-card-content>
            </mat-card>

            <!-- Santé Financière (Annuel) -->
            <mat-card class="!rounded-2xl !shadow-sm !border-none overflow-hidden h-full">
                <mat-card-header class="!px-6 !pt-6 border-b border-gray-100 pb-4 mb-4">
                    <mat-card-title class="!text-xl !font-bold flex items-center gap-2">
                        <mat-icon class="text-green-600">bar_chart</mat-icon>
                        Santé Financière ({{ currentYear }})
                    </mat-card-title>
                    <mat-card-subtitle class="mt-1">
                        Suivi des dépenses mensuelles vs Plafond
                    </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content class="!p-6">
                    <div class="relative w-full h-[350px]">
                        <canvas #healthChart></canvas>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</div>