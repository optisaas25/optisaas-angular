<div class="warehouse-detail-container" *ngIf="!loading && entrepot">
    <!-- Warehouse Info Card -->
    <mat-card class="warehouse-info-card">
        <mat-card-header>
            <mat-card-title>
                <h2>{{ entrepot.nom }}</h2>
            </mat-card-title>
            <div class="header-actions">
                <button mat-button (click)="goBack()" class="back-button">
                    <mat-icon>arrow_back</mat-icon>
                    <span>Retour</span>
                </button>
            </div>
            <mat-card-subtitle>
                <span class="badge" [ngClass]="entrepot.type?.toLowerCase()">{{ entrepot.type }}</span>
            </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="info-grid">
                <div class="info-item" *ngIf="entrepot.description">
                    <strong>Description:</strong>
                    <span>{{ entrepot.description }}</span>
                </div>
                <div class="info-item" *ngIf="entrepot.responsable">
                    <strong>Responsable:</strong>
                    <span>{{ entrepot.responsable }}</span>
                </div>
                <div class="info-item" *ngIf="entrepot.capaciteMax">
                    <strong>Capacité Max:</strong>
                    <span>{{ entrepot.capaciteMax }} m³</span>
                </div>
                <div class="info-item" *ngIf="entrepot.surface">
                    <strong>Surface:</strong>
                    <span>{{ entrepot.surface }} m²</span>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Products Card -->
    <mat-card class="products-card">
        <mat-card-header>
            <mat-card-title>
                <h3>Produits en Stock ({{ entrepot.produits?.length || 0 }})</h3>
            </mat-card-title>
            <div class="header-actions">

                <button mat-raised-button color="accent" (click)="navigateToAddProduct()">
                    <mat-icon>add_shopping_cart</mat-icon>
                    Ajouter Produit
                </button>
            </div>
        </mat-card-header>
        <mat-card-content>
            <!-- Filters -->
            <div class="filters-container">

                <mat-form-field appearance="outline" class="dense-form-field" style="width: 200px;">
                    <mat-label>Période</mat-label>
                    <mat-select [(ngModel)]="selectedPeriod" (selectionChange)="onPeriodChange()">
                        <mat-option value="all">Tout le temps</mat-option>
                        <mat-option value="today">Aujourd'hui</mat-option>
                        <mat-option value="week">Cette semaine</mat-option>
                        <mat-option value="month">Ce mois</mat-option>
                        <mat-option value="custom">Entre deux dates</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="dense-form-field" style="width: 280px;"
                    *ngIf="selectedPeriod === 'custom'">
                    <mat-label>Sélectionner dates</mat-label>
                    <mat-date-range-input [rangePicker]="picker">
                        <input matStartDate placeholder="Début" [(ngModel)]="startDate" (dateChange)="applyFilter()">
                        <input matEndDate placeholder="Fin" [(ngModel)]="endDate" (dateChange)="applyFilter()">
                    </mat-date-range-input>
                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-date-range-picker #picker></mat-date-range-picker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="dense-form-field" style="width: 200px;">
                    <mat-label>Entrepôt Source</mat-label>
                    <mat-select [(ngModel)]="selectedSourceWarehouse" (selectionChange)="applyFilter()">
                        <mat-option [value]="null">Tous</mat-option>
                        <mat-option *ngFor="let src of sourceWarehouses" [value]="src">{{ src }}</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>

            <table mat-table [dataSource]="entrepot.produits || []"
                *ngIf="entrepot.produits && entrepot.produits.length > 0" class="products-table">

                <!-- Designation Column -->
                <ng-container matColumnDef="designation">
                    <th mat-header-cell *matHeaderCellDef>Désignation</th>
                    <td mat-cell *matCellDef="let product">
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <strong>{{ product.designation }}</strong>
                                <span *ngIf="product.specificData?.pendingIncoming" class="badge-incoming"
                                    [class.shipped]="product.specificData.pendingIncoming.status === 'SHIPPED'">
                                    {{ product.specificData.pendingIncoming.status === 'SHIPPED' ? 'En Transit' :
                                    'Réservé' }}
                                </span>
                                <span *ngIf="product.specificData?.pendingOutgoing?.length" class="badge-outgoing">
                                    Sortant x{{ product.specificData.pendingOutgoing.length }}
                                </span>
                            </div>
                            <div class="secondary-text">{{ product.marque }} - {{ product.referenceFournisseur }}</div>
                        </div>
                    </td>
                    <td mat-footer-cell *matFooterCellDef> </td>
                </ng-container>

                <!-- Code Column -->
                <ng-container matColumnDef="codeInterne">
                    <th mat-header-cell *matHeaderCellDef>Code</th>
                    <td mat-cell *matCellDef="let product">{{ product.codeInterne }}</td>
                    <td mat-footer-cell *matFooterCellDef> </td>
                </ng-container>

                <!-- Source Column -->
                <ng-container matColumnDef="sourceEntrepot">
                    <th mat-header-cell *matHeaderCellDef> Source </th>
                    <td mat-cell *matCellDef="let element"> {{ getProductSource(element) || '-' }} </td>
                    <td mat-footer-cell *matFooterCellDef> </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="dateOperation">
                    <th mat-header-cell *matHeaderCellDef> Date Opération </th>
                    <td mat-cell *matCellDef="let element"> {{ getProductDate(element) | date:'dd/MM/yyyy HH:mm' }}
                    </td>
                    <td mat-footer-cell *matFooterCellDef> <strong>Total</strong> </td>
                </ng-container>

                <!-- Quantity Column -->
                <ng-container matColumnDef="quantiteActuelle">
                    <th mat-header-cell *matHeaderCellDef>Quantité</th>
                    <td mat-cell *matCellDef="let product">
                        {{ product.quantiteActuelle }}
                    </td>
                    <td mat-footer-cell *matFooterCellDef> <strong>{{ totalQuantity }}</strong> </td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="prixVenteHT">
                    <th mat-header-cell *matHeaderCellDef>Prix Vente TTC</th>
                    <td mat-cell *matCellDef="let product">{{ product.prixVenteTTC | currency:'MAD':'symbol':'1.2-2' }}
                    </td>
                    <td mat-footer-cell *matFooterCellDef> <strong>{{ totalValue | currency:'MAD':'symbol':'1.2-2'
                            }}</strong> </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let product">
                        <!-- History (Always visible) -->
                        <button mat-icon-button matTooltip="Mouvements" (click)="openHistory(product)">
                            <mat-icon>history</mat-icon>
                        </button>

                        <!-- Transfer Life Cycle Actions -->
                        <button mat-icon-button color="success" *ngIf="canShip(product)" (click)="shipTransfer(product)"
                            matTooltip="Valider l'expédition">
                            <mat-icon>local_shipping</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" *ngIf="canCancel(product)"
                            (click)="cancelTransfer(product)" matTooltip="Annuler le transfert">
                            <mat-icon>cancel</mat-icon>
                        </button>
                        <button mat-icon-button style="color: #2e7d32;" *ngIf="canReceive(product)"
                            (click)="receiveTransfer(product)" matTooltip="Confirmer la réception">
                            <mat-icon>download_for_offline</mat-icon>
                        </button>

                        <!-- Edit (Standard) -->
                        <button mat-icon-button matTooltip="Modifier" [routerLink]="['/p/stock', product.id]"
                            [disabled]="hasPendingTransferToCurrent(product)">
                            <mat-icon>edit</mat-icon>
                        </button>
                    </td>
                    <td mat-footer-cell *matFooterCellDef> </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                <tr mat-footer-row *matFooterRowDef="displayedColumns" class="custom-footer-row"></tr>
            </table>

            <div *ngIf="!entrepot.produits || entrepot.produits.length === 0" class="no-data">
                <mat-icon>inventory_2</mat-icon>
                <p>Aucun produit dans cet entrepôt</p>
                <button mat-raised-button color="accent">
                    <mat-icon>add</mat-icon>
                    Ajouter le premier produit
                </button>
            </div>
        </mat-card-content>
    </mat-card>
</div>

<div *ngIf="loading" class="loading">
    <p>Chargement...</p>
</div>