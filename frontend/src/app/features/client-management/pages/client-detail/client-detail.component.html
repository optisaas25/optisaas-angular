<div class="dossier-client-container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <button mat-icon-button (click)="goBack()" class="mr-2">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <h1>
                Dossier Client
                <span class="client-name-subtitle" *ngIf="client">
                    - {{ clientDisplayName }}
                    <span class="client-phone" *ngIf="client.telephone">
                        | <mat-icon>phone</mat-icon> {{ client.telephone }}
                    </span>
                </span>
            </h1>
            <span class="status-badge" [class.actif]="client?.statut === StatutClient.ACTIF"
                [class.inactif]="client?.statut === StatutClient.INACTIF">
                {{ client?.statut || 'N/A' }}
            </span>
        </div>
        <div class="header-actions">
            <button mat-flat-button color="primary" [matMenuTriggerFor]="createMenu" class="btn-create">
                <mat-icon>add</mat-icon> ACTIONS
            </button>
            <mat-menu #createMenu="matMenu" class="premium-menu">
                <button mat-menu-item (click)="createFicheMonture()">
                    <mat-icon color="primary">visibility</mat-icon> Nouvelle Fiche Monture
                </button>
                <button mat-menu-item (click)="createFicheLentilles()">
                    <mat-icon color="accent">remove_red_eye</mat-icon> Nouvelle Fiche Lentilles
                </button>
                <button mat-menu-item (click)="createFicheProduit()">
                    <mat-icon class="text-green-600">shopping_cart</mat-icon> Nouvelle Fiche Produit
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="createFacture()">
                    <mat-icon class="text-blue-600">receipt</mat-icon> Créer Facture / Devis
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="createSupplierInvoice()">
                    <mat-icon style="color: #673ab7;">add_shopping_cart</mat-icon> Ajouter BL Verre
                </button>
            </mat-menu>

            <button mat-icon-button [matMenuTriggerFor]="moreMenu">
                <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #moreMenu="matMenu">
                <button mat-menu-item (click)="completeProfile()">
                    <mat-icon>edit</mat-icon> Modifier le profil
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="deleteClient()" class="text-red-600">
                    <mat-icon color="warn">delete</mat-icon> Supprimer le client
                </button>
            </mat-menu>
        </div>
    </div>

    <!-- Reward Alert -->
    <div class="reward-alert-banner" *ngIf="isEligibleForReward">
        <div class="reward-alert-content">
            <div class="reward-icon-wrapper">
                <mat-icon class="reward-icon">celebration</mat-icon>
            </div>
            <div class="reward-text">
                <div class="reward-title">Objectif de points Fidelio atteint !</div>
                <div class="reward-subtitle">
                    Ce client a cumulé <strong>{{ client?.pointsFidelite || 0 }} points</strong> (Objectif : {{
                    rewardThreshold }} pts).
                    Vous pouvez débloquer une récompense.
                </div>
            </div>
        </div>
        <div class="reward-actions">
            <button mat-raised-button class="btn-reward-discount" (click)="redeemRewardWithType('DISCOUNT')">
                <mat-icon>percent</mat-icon> Appliquer Remise
            </button>
            <button mat-raised-button class="btn-reward-cash" (click)="redeemRewardWithType('MAD_BONUS')">
                <mat-icon>payments</mat-icon> Convertir en Bonus (MAD)
            </button>
        </div>
    </div>

    <!-- Stats Cards Section -->
    <div class="stats-grid mt-4" *ngIf="client">
        <mat-card class="stat-card stat-card-blue">
            <mat-card-content>
                <div class="stat-number">{{ clientStats().ca | currency:'MAD':'MAD ':'1.0-2' }}</div>
                <div class="stat-label">Chiffre d'Affaire</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card stat-card-green">
            <mat-card-content>
                <div class="stat-number">{{ clientStats().paiements | currency:'MAD':'MAD ':'1.0-2' }}</div>
                <div class="stat-label">Paiements</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card stat-card-red">
            <mat-card-content>
                <div class="stat-number">{{ clientStats().reste | currency:'MAD':'MAD ':'1.0-2' }}</div>
                <div class="stat-label">Reste à Payer</div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card stat-card-purple">
            <mat-card-content>
                <div class="stat-number">{{ client.pointsFidelite || 0 }}</div>
                <div class="stat-label">Points Fedilio</div>
            </mat-card-content>
        </mat-card>
    </div>



    <div class="main-content">
        <!-- Main Content: Tabs -->
        <div class="content-section">
            <mat-tab-group class="client-tabs" animationDuration="0ms">
                <!-- NEW: Onglet Fiches Médicales (Default) -->
                <mat-tab label="Fiches Médicales">
                    <div class="form-container">
                        <!-- Data Table -->
                        <div class="table-responsive">
                            <table mat-table [dataSource]="fiches" class="w-full">
                                <!-- Type Fiche Column -->
                                <ng-container matColumnDef="type">
                                    <th mat-header-cell *matHeaderCellDef>Type Fiche</th>
                                    <td mat-cell *matCellDef="let fiche">
                                        <div class="flex items-center gap-2">
                                            <mat-icon [class.text-primary]="fiche.type === TypeFiche.MONTURE"
                                                [class.text-accent]="fiche.type === TypeFiche.LENTILLES"
                                                class="scale-75">
                                                {{ getTypeIcon(fiche.type) }}
                                            </mat-icon>
                                            {{ fiche.type | uppercase }}
                                        </div>
                                    </td>
                                </ng-container>

                                <!-- Date Fiche Column -->
                                <ng-container matColumnDef="dateCreation">
                                    <th mat-header-cell *matHeaderCellDef>Date Fiche</th>
                                    <td mat-cell *matCellDef="let fiche">{{ fiche.dateCreation | date:'dd/MM/yyyy' }}
                                    </td>
                                </ng-container>

                                <!-- Fiche ID Column -->
                                <ng-container matColumnDef="dateLivraison">
                                    <th mat-header-cell *matHeaderCellDef>Ref Fiche</th>
                                    <td mat-cell *matCellDef="let fiche">
                                        {{ fiche.id?.substring(0, 12) }}
                                    </td>
                                </ng-container>

                                <!-- Docteur Column -->
                                <ng-container matColumnDef="docteur">
                                    <th mat-header-cell *matHeaderCellDef>Docteur</th>
                                    <td mat-cell *matCellDef="let fiche">{{ fiche.ordonnance?.prescripteur ||
                                        fiche.ordonnance?.nomMedecin || fiche.prescription?.nomMedecin || '-' }}</td>
                                </ng-container>

                                <!-- Type Equipement Column -->
                                <ng-container matColumnDef="typeEquipement">
                                    <th mat-header-cell *matHeaderCellDef>Type Equipement</th>
                                    <td mat-cell *matCellDef="let fiche">{{ fiche.monture?.typeEquipement ||
                                        fiche.lentilles?.type || '-' }}</td>
                                </ng-container>

                                <!-- Type Verre Column -->
                                <ng-container matColumnDef="typeVerre">
                                    <th mat-header-cell *matHeaderCellDef>Type Verre</th>
                                    <td mat-cell *matCellDef="let fiche">
                                        <div *ngFor="let line of getVerresSummary(fiche).split('\n')"
                                            class="table-multiline">
                                            {{ line }}
                                        </div>
                                    </td>
                                </ng-container>

                                <!-- Correction Column (ex-Nomenclature) -->
                                <ng-container matColumnDef="nomenclature">
                                    <th mat-header-cell *matHeaderCellDef>Correction</th>
                                    <td mat-cell *matCellDef="let fiche">
                                        <div *ngFor="let line of getCorrectionSummary(fiche).split('\n')"
                                            class="table-multiline">
                                            {{ line }}
                                        </div>
                                    </td>
                                </ng-container>

                                <!-- Actions Column -->
                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef style="text-align: right;">Actions</th>
                                    <td mat-cell *matCellDef="let fiche" style="text-align: right;">
                                        <button mat-icon-button [matMenuTriggerFor]="menu">
                                            <mat-icon>more_vert</mat-icon>
                                        </button>
                                        <mat-menu #menu="matMenu">
                                            <button mat-menu-item (click)="viewFiche(fiche)">
                                                <mat-icon class="premium-menu-icon-view">visibility</mat-icon>
                                                <span>Visualiser</span>
                                            </button>
                                            <button mat-menu-item (click)="sendControlReminder(fiche)">
                                                <mat-icon style="color: #25D366;">message</mat-icon>
                                                <span>Relance Contrôle</span>
                                            </button>
                                            <button mat-menu-item (click)="createSupplierInvoice()">
                                                <mat-icon style="color: #673ab7;">add_shopping_cart</mat-icon>
                                                <span>Ajouter BL Verre</span>
                                            </button>
                                            <mat-divider></mat-divider>
                                            <button mat-menu-item (click)="deleteFiche(fiche)">
                                                <mat-icon class="premium-menu-icon-delete">delete</mat-icon>
                                                <span>Supprimer</span>
                                            </button>
                                        </mat-menu>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Factures -->
                <mat-tab label="Facturation">
                    <div class="form-container">
                        <app-facture-list [clientId]="clientId"></app-facture-list>
                    </div>
                </mat-tab>

                <!-- Onglet BL Fournisseurs -->
                <mat-tab label="BL Fournisseurs">
                    <div class="form-container">
                        <div class="flex justify-between items-center mb-6">
                            <div class="section-title !mt-0">Bons de Livraison Verre / Fournisseur</div>
                            <button mat-raised-button color="primary" (click)="createSupplierInvoice()">
                                <mat-icon>add</mat-icon> Ajouter BL
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table mat-table [dataSource]="supplierInvoices()" class="w-full">

                                <ng-container matColumnDef="date">
                                    <th mat-header-cell *matHeaderCellDef>Date</th>
                                    <td mat-cell *matCellDef="let inv">{{ inv.dateEmission | date:'dd/MM/yyyy' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="numero">
                                    <th mat-header-cell *matHeaderCellDef>N° Facture</th>
                                    <td mat-cell *matCellDef="let inv" class="font-medium">{{ inv.numeroFacture }}</td>
                                </ng-container>

                                <ng-container matColumnDef="fournisseur">
                                    <th mat-header-cell *matHeaderCellDef>Fournisseur</th>
                                    <td mat-cell *matCellDef="let inv">{{ inv.fournisseur?.nom }}</td>
                                </ng-container>

                                <ng-container matColumnDef="montant">
                                    <th mat-header-cell *matHeaderCellDef>Montant TTC</th>
                                    <td mat-cell *matCellDef="let inv" class="font-bold text-right">{{ inv.montantTTC |
                                        currency:'MAD':'MAD ':'1.2-2' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="statut">
                                    <th mat-header-cell *matHeaderCellDef>Statut</th>
                                    <td mat-cell *matCellDef="let inv">
                                        <span class="status-badge" [class.actif]="inv.statut === 'PAYEE'"
                                            [class.inactif]="inv.statut === 'EN_ATTENTE' || inv.statut === 'RETARD'"
                                            [class.partiel]="inv.statut === 'PARTIELLE'">
                                            {{ inv.statut }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef style="text-align: right;">Actions</th>
                                    <td mat-cell *matCellDef="let inv" style="text-align: right;">
                                        <button mat-icon-button [matMenuTriggerFor]="menuBL">
                                            <mat-icon>more_vert</mat-icon>
                                        </button>
                                        <mat-menu #menuBL="matMenu">
                                            <button mat-menu-item (click)="viewSupplierInvoice(inv)">
                                                <mat-icon>visibility</mat-icon> Voir
                                            </button>
                                            <button mat-menu-item (click)="openPaymentDialog(inv)"
                                                *ngIf="inv.statut !== 'PAYEE'">
                                                <mat-icon color="primary">payments</mat-icon> Payer
                                            </button>
                                            <button mat-menu-item class="text-red-600"
                                                (click)="deleteSupplierInvoice(inv)">
                                                <mat-icon color="warn">delete</mat-icon> Supprimer
                                            </button>
                                        </mat-menu>
                                    </td>
                                </ng-container>

                                <tr mat-header-row
                                    *matHeaderRowDef="['date', 'numero', 'fournisseur', 'montant', 'statut', 'actions']">
                                </tr>
                                <tr mat-row
                                    *matRowDef="let row; columns: ['date', 'numero', 'fournisseur', 'montant', 'statut', 'actions'];">
                                </tr>
                            </table>
                            <div *ngIf="supplierInvoices().length === 0"
                                class="empty-state p-8 text-center text-gray-500">
                                Aucun BL fournisseur lié à ce dossier.
                            </div>
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Paiements -->
                <mat-tab label="Paiements">
                    <div class="form-container">
                        <app-payment-list [clientId]="clientId" (paymentAdded)="loadStats()"></app-payment-list>
                    </div>
                </mat-tab>

                <!-- Onglet Fichiers (Attachments) -->
                <mat-tab label="Fichiers">
                    <div class="form-container">
                        <div class="flex justify-between items-center mb-6">
                            <div class="section-title !mt-0">Documents & Pièces Jointes</div>
                            <div class="flex gap-2">
                                <input type="file" #fileInput class="hidden" (change)="onFileSelected($event)">
                                <button mat-stroked-button color="primary" (click)="fileInput.click()">
                                    <mat-icon>upload_file</mat-icon> Importer un fichier
                                </button>
                                <button mat-raised-button color="primary" (click)="openCamera()">
                                    <mat-icon>camera_alt</mat-icon> Prendre une photo
                                </button>
                            </div>
                        </div>

                        <div class="attachments-grid" *ngIf="attachments().length > 0">
                            <mat-card *ngFor="let file of attachments()" class="attachment-card">
                                <div class="file-preview" (click)="downloadAttachment(file)">
                                    <mat-icon>{{ getFileIcon(file.type) }}</mat-icon>
                                </div>
                                <mat-card-content>
                                    <div class="file-info" [matTooltip]="file.name">
                                        <div class="file-name text-truncate">{{ file.name }}</div>
                                        <div class="file-date">{{ file.date | date:'dd/MM/yyyy HH:mm' }}</div>
                                    </div>
                                </mat-card-content>
                                <mat-divider></mat-divider>
                                <mat-card-actions align="end">
                                    <button mat-icon-button color="warn"
                                        (click)="$event.stopPropagation(); deleteAttachment(file.id)"
                                        matTooltip="Supprimer">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                    <button mat-icon-button color="primary"
                                        (click)="$event.stopPropagation(); downloadAttachment(file)"
                                        matTooltip="Visualiser / Télécharger">
                                        <mat-icon>download</mat-icon>
                                    </button>
                                </mat-card-actions>
                            </mat-card>
                        </div>

                        <div *ngIf="attachments().length === 0" class="empty-state p-12 text-center text-gray-400">
                            <mat-icon class="scale-150 mb-4 opacity-20">inventory_2</mat-icon>
                            <p>Aucun fichier joint à ce dossier.</p>
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Identité Client -->
                <mat-tab label="Identité Client">
                    <div class="form-container" *ngIf="client">
                        <ng-container *ngIf="clientParticulier">
                            <div class="form-row three-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Titre</mat-label>
                                    <mat-select [value]="clientParticulier.titre" class="readonly-state">
                                        <mat-option [value]="clientParticulier.titre">{{ clientParticulier.titre
                                            }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Nom</mat-label>
                                    <input matInput [value]="clientParticulier.nom" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Prénom</mat-label>
                                    <input matInput [value]="clientParticulier.prenom" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Date de naissance</mat-label>
                                    <input matInput [value]="clientParticulier.dateNaissance | date:'dd/MM/yyyy'"
                                        readonly>
                                    <mat-icon matSuffix>calendar_today</mat-icon>
                                </mat-form-field>
                            </div>

                            <div class="section-title">DOCUMENT D'IDENTITÉ</div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Type de pièce</mat-label>
                                    <mat-select [value]="clientParticulier.typePieceIdentite" class="readonly-state">
                                        <mat-option [value]="clientParticulier.typePieceIdentite">{{
                                            clientParticulier.typePieceIdentite }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <!-- Show CIN Parent for children, regular ID for adults -->
                                <mat-form-field appearance="outline" *ngIf="clientParticulier.titre === 'Enf'">
                                    <mat-label>CIN Parent</mat-label>
                                    <input matInput [value]="clientParticulier.cinParent || ''" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline" *ngIf="clientParticulier.titre !== 'Enf'">
                                    <mat-label>Numéro de pièce</mat-label>
                                    <input matInput [value]="clientParticulier.numeroPieceIdentite" readonly>
                                </mat-form-field>
                            </div>

                            <div class="section-title">CONTACT & LOCALISATION</div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Téléphone</mat-label>
                                    <input matInput [value]="clientParticulier.telephone" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Email</mat-label>
                                    <input matInput [value]="clientParticulier.email || ''" readonly>
                                </mat-form-field>
                            </div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Ville</mat-label>
                                    <input matInput [value]="clientParticulier.ville" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Adresse</mat-label>
                                    <input matInput [value]="clientParticulier.adresse || ''" readonly>
                                </mat-form-field>
                            </div>

                            <div class="section-title">Couverture Sociale</div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Type de couverture</mat-label>
                                    <mat-select [value]="clientParticulier.couvertureSociale?.type"
                                        class="readonly-state">
                                        <mat-option [value]="clientParticulier.couvertureSociale?.type">{{
                                            clientParticulier.couvertureSociale?.type || 'Aucune' }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Numéro d'adhésion</mat-label>
                                    <input matInput [value]="clientParticulier.couvertureSociale?.numeroAdhesion || ''"
                                        readonly>
                                </mat-form-field>
                            </div>

                            <div class="section-title">Groupe Famille et Le Lien Parental</div>
                            <!-- Cas Principal : Role + Nom Famille -->
                            <ng-container *ngIf="clientParticulier.groupeFamille?.role === 'Principal'">
                                <div class="form-row two-cols">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Rôle Client</mat-label>
                                        <mat-select value="Principal" class="readonly-state">
                                            <mat-option value="Principal">Principal</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Nom Famille</mat-label>
                                        <input matInput [value]="clientParticulier.groupeFamille?.nomFamille || ''"
                                            readonly>
                                    </mat-form-field>
                                </div>
                            </ng-container>

                            <!-- Cas Membre : Role + Lien Parental + ID + Nom Famille -->
                            <ng-container *ngIf="clientParticulier.groupeFamille?.role === 'Membre'">
                                <div class="form-row two-cols">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Rôle Client</mat-label>
                                        <mat-select value="Membre" class="readonly-state">
                                            <mat-option value="Membre">Membre</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Lien Parental</mat-label>
                                        <mat-select [value]="clientParticulier.groupeFamille?.lienParental"
                                            class="readonly-state">
                                            <mat-option [value]="clientParticulier.groupeFamille?.lienParental">{{
                                                clientParticulier.groupeFamille?.lienParental || '-' }}</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-row two-cols">
                                    <mat-form-field appearance="outline">
                                        <mat-label>ID Famille</mat-label>
                                        <input matInput disabled value="">
                                    </mat-form-field>
                                    <mat-form-field appearance="outline">
                                        <mat-label>Nom Famille</mat-label>
                                        <input matInput [value]="clientParticulier.groupeFamille?.nomFamille || ''"
                                            readonly>
                                    </mat-form-field>
                                </div>
                            </ng-container>
                        </ng-container>

                        <!-- Professionnel -->
                        <ng-container *ngIf="clientProfessionnel">
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Raison Sociale</mat-label>
                                    <input matInput [value]="clientProfessionnel.raisonSociale" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Identifiant Fiscal</mat-label>
                                    <input matInput [value]="clientProfessionnel.identifiantFiscal" readonly>
                                </mat-form-field>
                            </div>
                            <div class="form-row three-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>ICE</mat-label>
                                    <input matInput [value]="clientProfessionnel.ice" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Registre Commerce</mat-label>
                                    <input matInput [value]="clientProfessionnel.registreCommerce || ''" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Patente</mat-label>
                                    <input matInput [value]="clientProfessionnel.patente || ''" readonly>
                                </mat-form-field>
                            </div>

                            <div class="section-title">LOCALISATION & CONTACT</div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Téléphone</mat-label>
                                    <input matInput [value]="clientProfessionnel.telephone" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Email</mat-label>
                                    <input matInput [value]="clientProfessionnel.email" readonly>
                                </mat-form-field>
                            </div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Ville</mat-label>
                                    <input matInput [value]="clientProfessionnel.ville" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Adresse</mat-label>
                                    <input matInput [value]="clientProfessionnel.adresse || ''" readonly>
                                </mat-form-field>
                            </div>

                            <div class="section-title">FISCALITÉ</div>
                            <div class="form-row two-cols">
                                <mat-checkbox [checked]="clientProfessionnel.tvaAssujetti"
                                    class="readonly-state">Assujetti
                                    à la TVA</mat-checkbox>
                                <mat-form-field appearance="outline" *ngIf="clientProfessionnel.tvaAssujetti">
                                    <mat-label>Numéro d'Autorisation</mat-label>
                                    <input matInput [value]="clientProfessionnel.numeroAutorisation || ''" readonly>
                                </mat-form-field>
                            </div>
                        </ng-container>
                    </div>
                </mat-tab>

                <!-- Onglet Dossier Médical (Particulier Only) -->
                <mat-tab label="Dossier Médical" *ngIf="clientParticulier">
                    <div class="form-container medical-container" *ngIf="clientParticulier?.dossierMedical as dossier">
                        <div class="medical-columns">
                            <!-- Col 1: Antecedents Visuels -->
                            <div class="medical-col">
                                <div class="section-title">ANTÉCÉDENTS VISUELS</div>

                                <label class="field-label">Portez-vous actuellement</label>
                                <mat-radio-group [value]="dossier.correctionActuelle"
                                    class="custom-radio-group readonly-state">
                                    <mat-radio-button value="Lunettes">Lunettes</mat-radio-button>
                                    <mat-radio-button value="Lentilles de contact">Lentilles</mat-radio-button>
                                    <mat-radio-button value="Rien">Rien</mat-radio-button>
                                </mat-radio-group>

                                <label class="field-label mt-4">Depuis combien de temps portez-vous une correction
                                    visuelle ?</label>
                                <mat-radio-group [value]="dossier.dureePort" class="custom-radio-group readonly-state">
                                    <mat-radio-button value="Moins de 1 an">Moins de 1 an</mat-radio-button>
                                    <mat-radio-button value="1 à 5 ans">1 à 5 ans</mat-radio-button>
                                    <mat-radio-button value="Plus de 5 ans">Plus de 5 ans</mat-radio-button>
                                </mat-radio-group>

                                <label class="field-label mt-4">Avez-vous déjà eu</label>
                                <div class="checkbox-list">
                                    <mat-checkbox [checked]="dossier.traumatisme" class="readonly-state">Un traumatisme
                                        oculaire</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.operation" class="readonly-state">Une opération des
                                        yeux</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.inflammation" class="readonly-state">Une
                                        inflammation</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.sensibiliteLumiere" class="readonly-state">Une
                                        sensibilité à la lumière</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.secheresse" class="readonly-state">Une
                                        sécheresse</mat-checkbox>
                                </div>

                                <label class="field-label mt-4">Avez-vous des antécédents familiaux de</label>
                                <div class="checkbox-row">
                                    <mat-checkbox [checked]="dossier.antecedentsFamiliaux?.glaucome"
                                        class="readonly-state">Glaucome</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.antecedentsFamiliaux?.dmla"
                                        class="readonly-state">DMLA</mat-checkbox>
                                </div>
                                <div class="checkbox-row">
                                    <mat-checkbox [checked]="dossier.antecedentsFamiliaux?.diabete"
                                        class="readonly-state">Diabète</mat-checkbox>
                                </div>

                                <mat-form-field appearance="outline" class="mt-2 full-width">
                                    <mat-label>Autres maladies oculaires</mat-label>
                                    <textarea matInput [value]="dossier.antecedentsFamiliaux?.autres || ''" readonly
                                        rows="2"></textarea>
                                </mat-form-field>
                            </div>

                            <!-- Col 2: Antecedents Medicaux Gen -->
                            <div class="medical-col">
                                <div class="section-title">ANTÉCÉDENTS MÉDICAUX GÉNÉRAUX</div>

                                <label class="field-label">Êtes-vous suivi pour une ou plusieurs maladies chroniques
                                    ?</label>
                                <mat-checkbox [checked]="dossier.maladiesChroniques?.actif"
                                    class="readonly-state">Oui</mat-checkbox>
                                <mat-form-field appearance="outline" class="full-width mt-2"
                                    *ngIf="dossier.maladiesChroniques?.actif">
                                    <mat-label>Précisez</mat-label>
                                    <input matInput [value]="dossier.maladiesChroniques?.details || ''" readonly>
                                </mat-form-field>

                                <label class="field-label mt-4">Prenez-vous actuellement un traitement médicamenteux
                                    régulier ?</label>
                                <mat-checkbox [checked]="dossier.traitementMedicamenteux?.actif"
                                    class="readonly-state">Oui</mat-checkbox>
                                <mat-form-field appearance="outline" class="full-width mt-2"
                                    *ngIf="dossier.traitementMedicamenteux?.actif">
                                    <mat-label>Précisez</mat-label>
                                    <input matInput [value]="dossier.traitementMedicamenteux?.details || ''" readonly>
                                </mat-form-field>

                                <label class="field-label mt-4">Avez-vous des allergies connues ?</label>
                                <mat-checkbox [checked]="dossier.allergies?.actif"
                                    class="readonly-state">Oui</mat-checkbox>
                                <mat-form-field appearance="outline" class="full-width mt-2"
                                    *ngIf="dossier.allergies?.actif">
                                    <mat-label>Précisez</mat-label>
                                    <input matInput [value]="dossier.allergies?.details || ''" readonly>
                                </mat-form-field>
                            </div>

                            <!-- Col 3: Habitudes -->
                            <div class="medical-col">
                                <div class="section-title">HABITUDES ET CONFORT VISUEL</div>

                                <label class="field-label">Passez-vous plus de 4h par jour devant un écran ?</label>
                                <mat-radio-group [value]="dossier.ecranPlus4h"
                                    class="custom-radio-group readonly-state">
                                    <mat-radio-button [value]="true">Oui</mat-radio-button>
                                    <mat-radio-button [value]="false">Non</mat-radio-button>
                                </mat-radio-group>

                                <label class="field-label mt-4">Ressentez-vous souvent :</label>
                                <div class="checkbox-list">
                                    <mat-checkbox [checked]="dossier.ressenti?.fatigue" class="readonly-state">Fatigue
                                        visuelle</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.ressenti?.mauxTete" class="readonly-state">Maux de
                                        tête</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.ressenti?.visionFloue"
                                        class="readonly-state">Vision
                                        floue</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.ressenti?.picotements"
                                        class="readonly-state">Picotements / démangeaisons</mat-checkbox>
                                    <mat-checkbox [checked]="dossier.ressenti?.difficultePresLoin"
                                        class="readonly-state">Difficulté à voir de près / de loin</mat-checkbox>
                                </div>

                                <label class="field-label mt-4">Pratiquez-vous un sport ou une activité nécessitant une
                                    vision spécifique ?</label>
                                <mat-checkbox [checked]="dossier.sport?.actif" class="readonly-state">Oui</mat-checkbox>
                                <mat-form-field appearance="outline" class="full-width mt-2"
                                    *ngIf="dossier.sport?.actif">
                                    <mat-label>Précisez</mat-label>
                                    <input matInput [value]="dossier.sport?.details || ''" readonly>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Convention & Contacts (Professionnel Only) -->
                <mat-tab label="Convention & Contacts" *ngIf="clientProfessionnel">
                    <div class="form-container">
                        <div class="section-title">CONVENTION</div>
                        <div class="form-row two-cols">
                            <!-- Example Convention fields -->
                            <mat-checkbox [checked]="clientProfessionnel.convention?.actif"
                                class="readonly-state">Convention Active</mat-checkbox>
                            <mat-form-field appearance="outline" *ngIf="clientProfessionnel.convention?.actif">
                                <mat-label>Nom Convention</mat-label>
                                <input matInput [value]="clientProfessionnel.convention?.nomConvention || ''" readonly>
                            </mat-form-field>
                        </div>
                        <div class="form-row two-cols" *ngIf="clientProfessionnel.convention?.actif">
                            <mat-form-field appearance="outline">
                                <mat-label>Modalité Paiement</mat-label>
                                <input matInput [value]="clientProfessionnel.convention?.modalitePaiement" readonly>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>Échéance Paiement</mat-label>
                                <input matInput [value]="clientProfessionnel.convention?.echeancePaiement" readonly>
                            </mat-form-field>
                        </div>

                        <div class="section-title">CONTACTS INTERNES</div>
                        <div *ngFor="let contact of clientProfessionnel.contacts" class="contact-card mb-4">
                            <div class="form-row three-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Nom</mat-label>
                                    <input matInput [value]="contact.nom" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Prénom</mat-label>
                                    <input matInput [value]="contact.prenom" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Fonction</mat-label>
                                    <input matInput [value]="contact.fonction" readonly>
                                </mat-form-field>
                            </div>
                            <div class="form-row two-cols">
                                <mat-form-field appearance="outline">
                                    <mat-label>Téléphone</mat-label>
                                    <input matInput [value]="contact.telephone" readonly>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Email</mat-label>
                                    <input matInput [value]="contact.email" readonly>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Notes (Particulier Only) -->
                <mat-tab label="Notes" *ngIf="clientParticulier">
                    <div class="form-container">
                        <mat-form-field appearance="outline" class="full-width notes-field">
                            <mat-label>Notes et observations</mat-label>
                            <textarea matInput [value]="clientParticulier?.dossierMedical?.notes || ''" readonly
                                rows="15"></textarea>
                        </mat-form-field>
                    </div>
                </mat-tab>

                <!-- Onglet Fidélité -->
                <mat-tab label="Fidélité Fidelio">
                    <div class="form-container">
                        <div class="section-title">HISTORIQUE DES POINTS</div>
                        <div class="table-responsive">
                            <table mat-table [dataSource]="pointsHistory()" class="w-full">
                                <ng-container matColumnDef="date">
                                    <th mat-header-cell *matHeaderCellDef>Date</th>
                                    <td mat-cell *matCellDef="let entry">{{ entry.date | date:'dd/MM/yyyy HH:mm' }}</td>
                                </ng-container>

                                <ng-container matColumnDef="type">
                                    <th mat-header-cell *matHeaderCellDef>Type</th>
                                    <td mat-cell *matCellDef="let entry">
                                        <span class="status-badge"
                                            [class.actif]="entry.type === 'ACHAT' || entry.type === 'PARRAINAGE'"
                                            [class.inactif]="entry.type === 'UTILISATION' || entry.type === 'EXPIRATION' || entry.type === 'ANNULATION'">
                                            {{ entry.type }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="description">
                                    <th mat-header-cell *matHeaderCellDef>Description</th>
                                    <td mat-cell *matCellDef="let entry">
                                        {{ entry.description }}
                                        <span class="text-xs text-gray-500" *ngIf="entry.facture">
                                            (Facture: {{ entry.facture.numero }})
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="points">
                                    <th mat-header-cell *matHeaderCellDef>Points</th>
                                    <td mat-cell *matCellDef="let entry" [class.text-green-600]="entry.points > 0"
                                        [class.text-red-600]="entry.points < 0">
                                        {{ entry.points > 0 ? '+' : '' }}{{ entry.points }}
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="['date', 'type', 'description', 'points']"></tr>
                                <tr mat-row *matRowDef="let row; columns: ['date', 'type', 'description', 'points'];">
                                </tr>
                            </table>
                        </div>

                        <div *ngIf="pointsHistory().length === 0" class="empty-state p-8 text-center text-gray-500">
                            Aucun historique de points pour ce client.
                        </div>
                    </div>
                </mat-tab>

                <!-- Onglet Relations -->
                <mat-tab label="Relations & Parrainage">
                    <div class="form-container">
                        <!-- Parrain -->
                        <div class="section-title">MON PARRAIN</div>
                        <div *ngIf="parrain"
                            class="relation-card p-4 border rounded-lg bg-gray-50 flex justify-between items-center mb-6">
                            <div>
                                <div class="font-bold text-lg">{{ formatClientName(parrain) }}</div>
                                <div class="text-sm text-gray-600">
                                    <mat-icon class="scale-75 align-middle">phone</mat-icon> {{ parrain.telephone ||
                                    'N/A' }}
                                    | <mat-icon class="scale-75 align-middle">email</mat-icon> {{ parrain.email || 'N/A'
                                    }}
                                </div>
                            </div>
                            <button mat-stroked-button color="primary"
                                (click)="clientId = parrain.id; loadClientData()">
                                Voir Dossier
                            </button>
                        </div>
                        <div *ngIf="!parrain"
                            class="empty-state p-4 border dashed rounded-lg text-center text-gray-400 mb-6">
                            Pas de parrain enregistré.
                        </div>

                        <!-- Filleuls -->
                        <div class="section-title">MES FILLEULS ({{ filleuls.length }})</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div *ngFor="let filleul of filleuls"
                                class="relation-card p-4 border rounded-lg bg-white flex justify-between items-center">
                                <div>
                                    <div class="font-medium">{{ formatClientName(filleul) }}</div>
                                    <div class="text-xs text-gray-500">Inscrit le {{ filleul.dateCreation |
                                        date:'dd/MM/yyyy' }}</div>
                                </div>
                                <button mat-icon-button (click)="clientId = filleul.id; loadClientData()">
                                    <mat-icon>open_in_new</mat-icon>
                                </button>
                            </div>
                        </div>
                        <div *ngIf="filleuls.length === 0"
                            class="empty-state p-4 border dashed rounded-lg text-center text-gray-400">
                            Aucun filleul enregistré.
                        </div>
                    </div>
                </mat-tab>

                <!-- End of tabs -->
            </mat-tab-group>

        </div>
    </div>
</div>