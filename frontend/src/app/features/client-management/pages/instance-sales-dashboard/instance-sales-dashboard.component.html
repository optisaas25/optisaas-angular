<div class="dashboard-container">
    <div class="header">
        <div class="title-section">
            <h1>
                <mat-icon>pending_actions</mat-icon>
                Ventes en Instance
            </h1>
            <p class="subtitle">Gestion des ventes en attente de réception produit</p>
        </div>
        <button mat-raised-button color="primary" (click)="monitor.refreshNow()">
            <mat-icon>refresh</mat-icon>
            Actualiser
        </button>
    </div>

    <!-- Informational Banners -->
    <div class="banners-section" *ngIf="instanceSales$ | async as sales">
        <!-- BLUE BANNER: In Transit -->
        <ng-container *ngIf="hasStatus(sales, 'IN_TRANSIT')">
            <div class="info-banner transit-banner">
                <mat-icon>local_shipping</mat-icon>
                <div class="banner-text">
                    <strong>Arrivages en cours</strong>
                    <p>{{ countByStatus(sales, 'IN_TRANSIT') }} vente(s) ont des produits en cours d'acheminement.
                        Confirmez la réception une fois les colis arrivés.</p>
                </div>
            </div>
        </ng-container>

        <!-- GREEN BANNER: Ready for Validation -->
        <ng-container *ngIf="hasStatus(sales, 'READY')">
            <div class="info-banner ready-banner">
                <mat-icon>check_circle</mat-icon>
                <div class="banner-text">
                    <strong>Prêt pour Validation</strong>
                    <p>{{ countByStatus(sales, 'READY') }} vente(s) sont prêtes à être finalisées. Tous les produits ont
                        été reçus.</p>
                </div>
            </div>
        </ng-container>
    </div>

    <mat-card class="sales-table-card">
        <div class="table-container">
            <table mat-table [dataSource]="instanceSales$ | async" class="sales-table">
                <!-- Client Column -->
                <ng-container matColumnDef="client">
                    <th mat-header-cell *matHeaderCellDef>Client</th>
                    <td mat-cell *matCellDef="let sale">
                        <div class="client-cell">
                            <mat-icon class="client-icon">person</mat-icon>
                            <span>{{ sale.facture.client?.nom || 'N/A' }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Numero Column -->
                <ng-container matColumnDef="numero">
                    <th mat-header-cell *matHeaderCellDef>Numéro</th>
                    <td mat-cell *matCellDef="let sale">
                        <span class="numero-badge">{{ sale.facture.numero }}</span>
                    </td>
                </ng-container>

                <!-- Produits Column -->
                <ng-container matColumnDef="produits">
                    <th mat-header-cell *matHeaderCellDef>Produits</th>
                    <td mat-cell *matCellDef="let sale">
                        <div class="products-cell">
                            <mat-icon class="products-icon">inventory_2</mat-icon>
                            <span>{{ getProductsSummary(sale.facture.lignes) }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Statut Column -->
                <ng-container matColumnDef="statut">
                    <th mat-header-cell *matHeaderCellDef>Statut</th>
                    <td mat-cell *matCellDef="let sale">
                        <div class="status-badge" [ngClass]="getStatusBadge(sale.status).class">
                            <mat-icon>{{ getStatusBadge(sale.status).icon }}</mat-icon>
                            <span>{{ getStatusBadge(sale.status).label }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Montant Column -->
                <ng-container matColumnDef="montant">
                    <th mat-header-cell *matHeaderCellDef>Montant</th>
                    <td mat-cell *matCellDef="let sale">
                        <div class="montant-cell">
                            <span class="amount">{{ sale.facture.totalTTC | number:'1.2-2' }}</span>
                            <span class="currency">MAD</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let sale">
                        <div class="date-cell">
                            <mat-icon class="date-icon">calendar_today</mat-icon>
                            <span>{{ sale.facture.dateEmission | date:'dd/MM/yyyy' }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let sale">
                        <button mat-icon-button [matMenuTriggerFor]="menu" class="actions-button">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                        <mat-menu #menu="matMenu">
                            <!-- New: Valider la Réception -->
                            <button mat-menu-item (click)="validateReception(sale)"
                                *ngIf="sale.status === 'IN_TRANSIT'">
                                <mat-icon color="accent">local_shipping</mat-icon>
                                <span>Valider la réception</span>
                            </button>

                            <!-- Valider la vente -->
                            <button mat-menu-item (click)="validateSale(sale)" [disabled]="sale.status !== 'READY'">
                                <mat-icon [class.disabled-icon]="sale.status !== 'READY'"
                                    color="primary">check_circle</mat-icon>
                                <span>Valider la vente</span>
                            </button>

                            <button mat-menu-item (click)="viewDetails(sale)">
                                <mat-icon>visibility</mat-icon>
                                <span>Voir les détails</span>
                            </button>
                            <mat-divider></mat-divider>
                            <button mat-menu-item (click)="cancelSale(sale)" [disabled]="sale.status === 'CANCELLED'">
                                <mat-icon [class.disabled-icon]="sale.status === 'CANCELLED'">cancel</mat-icon>
                                <span>Annuler la vente</span>
                            </button>
                        </mat-menu>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.ready-row]="row.status === 'READY'">
                </tr>
            </table>

            <div *ngIf="(instanceSales$ | async)?.length === 0" class="no-data">
                <mat-icon>inbox</mat-icon>
                <p>Aucune vente en instance</p>
                <span class="no-data-subtitle">Les ventes en attente de réception apparaîtront ici</span>
            </div>
        </div>
    </mat-card>
</div>