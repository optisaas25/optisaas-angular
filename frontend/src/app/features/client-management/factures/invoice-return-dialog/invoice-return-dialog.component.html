<h2 mat-dialog-title>Retour / Échange de Produits</h2>

<mat-dialog-content>
    <div class="subtitle mb-4">
        Sélectionnez les articles à retourner pour générer un avoir et une facture d'échange.
    </div>

    <form [formGroup]="form">
        <mat-form-field appearance="outline" class="w-full">
            <mat-label>Motif du retour</mat-label>
            <mat-select formControlName="reason" required>
                <mat-option value="DEFECTUEUX">Produit Défectueux (Retour Stock Défectueux)</mat-option>
                <mat-option value="ERREUR_SAISIE">Erreur de Saisie (Retour Stock Normal)</mat-option>
                <mat-option value="CHANGEMENT_AVIS">Changement d'Avis (Retour Stock Normal)</mat-option>
            </mat-select>
        </mat-form-field>

        <div class="items-list">
            <div *ngFor="let item of data.facture.lignes; let i = index" class="item-row">
                <!-- Checkbox to select item -->
                <mat-checkbox [checked]="isSelected(i)" (change)="toggleSelection(i)" color="primary">
                </mat-checkbox>

                <div class="item-details">
                    <div class="item-name">{{ item.description || item.designation }}</div>
                    <div class="item-meta">
                        Qté: {{ item.qte }} | Prix: {{ item.prixUnitaireTTC |
                        currency:'MAD':'symbol':'1.2-2' }}
                    </div>
                </div>

                <!-- Quantity to return input, only visible if selected -->
                <mat-form-field *ngIf="isSelected(i)" appearance="outline" class="qty-input">
                    <mat-label>Qté Retour</mat-label>
                    <input matInput type="number" [formControl]="getQuantityControl(i)" min="1" [max]="item.qte">
                </mat-form-field>
            </div>
        </div>
    </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">Annuler</button>
    <button mat-raised-button color="primary" [disabled]="form.invalid || selectedItems.size === 0" (click)="confirm()">
        Valider l'Échange
    </button>
</mat-dialog-actions>