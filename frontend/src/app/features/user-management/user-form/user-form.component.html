<div class="user-form-container p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold m-0">
            {{ isEditMode ? 'Modifier l\'utilisateur' : 'Ajouter un utilisateur' }}
        </h1>
        <button mat-icon-button (click)="onCancel()" matTooltip="Retour">
            <mat-icon>arrow_back</mat-icon>
        </button>
    </div>

    <!-- Form -->
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
        <mat-card class="form-card mb-4">
            <mat-card-content>
                <div class="main-info-grid">
                    <div class="fields-column">
                        <!-- Status Section -->
                        <div class="status-section-compact mb-4">
                            <label class="section-label">Statut</label>
                            <div class="status-checkbox-group">
                                <mat-checkbox [checked]="isStatusSelected('actif')" (change)="toggleStatus('actif')">
                                    Actif
                                </mat-checkbox>
                                <mat-checkbox [checked]="isStatusSelected('inactif')"
                                    (change)="toggleStatus('inactif')">
                                    Inactif
                                </mat-checkbox>
                            </div>
                        </div>

                        <!-- Row 1: Civilité, Nom, Prénom -->
                        <div class="form-row three-cols">
                            <mat-form-field class="form-field">
                                <mat-label>Civilité</mat-label>
                                <mat-select formControlName="civilite">
                                    <mat-option *ngFor="let civilite of civilites" [value]="civilite">
                                        {{ civilite }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>

                            <mat-form-field class="form-field">
                                <mat-label>Nom</mat-label>
                                <input matInput formControlName="nom" placeholder="Saisir le nom">
                                <mat-error *ngIf="userForm.get('nom')?.hasError('required')">
                                    Le nom est requis
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field class="form-field">
                                <mat-label>Prénom</mat-label>
                                <input matInput formControlName="prenom" placeholder="Saisir le prénom">
                                <mat-error *ngIf="userForm.get('prenom')?.hasError('required')">
                                    Le prénom est requis
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Row 2: Email, Téléphone, Matricule -->
                        <div class="form-row three-cols">
                            <mat-form-field class="form-field">
                                <mat-label>Email</mat-label>
                                <input matInput type="email" formControlName="email" placeholder="email@exemple.com">
                                <mat-error *ngIf="userForm.get('email')?.hasError('required')">
                                    L'email est requis
                                </mat-error>
                                <mat-error *ngIf="userForm.get('email')?.hasError('email')">
                                    Email invalide
                                </mat-error>
                            </mat-form-field>

                            <mat-form-field class="form-field">
                                <mat-label>Téléphone</mat-label>
                                <input matInput formControlName="telephone" placeholder="0XXXXXXXXX">
                            </mat-form-field>

                            <mat-form-field class="form-field">
                                <mat-label>Matricule</mat-label>
                                <input matInput formControlName="matricule" placeholder="Saisir le matricule">
                            </mat-form-field>
                        </div>

                    </div>

                    <div class="photo-column">
                        <!-- Photo Section -->
                        <div class="photo-section">
                            <label class="section-label">Photo de profil</label>

                            <div class="photo-display">
                                <!-- Photo Preview or Placeholder -->
                                <div class="photo-preview-compact"
                                    *ngIf="photoPreview || userForm.get('photoUrl')?.value">
                                    <img [src]="photoPreview || userForm.get('photoUrl')?.value"
                                        alt="Photo de profil" />
                                    <button mat-icon-button type="button" class="remove-photo-btn-compact"
                                        (click)="removePhoto()" matTooltip="Supprimer">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                </div>
                                <div class="photo-placeholder-compact"
                                    *ngIf="!photoPreview && !userForm.get('photoUrl')?.value">
                                    <mat-icon>account_circle</mat-icon>
                                </div>

                                <!-- Upload Buttons -->
                                <div class="upload-buttons-compact">
                                    <input type="file" #photoInput accept="image/*" (change)="onPhotoSelected($event)"
                                        style="display: none" />
                                    <button mat-icon-button color="accent" type="button" (click)="photoInput.click()"
                                        matTooltip="Choisir fichier">
                                        <mat-icon>upload</mat-icon>
                                    </button>
                                    <button mat-icon-button color="primary" type="button" (click)="openCamera()"
                                        matTooltip="Prendre photo">
                                        <mat-icon>photo_camera</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Centre-Role Associations -->
        <mat-card class="form-card mb-4">
            <mat-card-header>
                <mat-card-title>Centres et Rôles</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="centre-roles-header">
                    <div class="header-col">Centre</div>
                    <div class="header-col">Entrepôts</div>
                    <div class="header-col">Rôle</div>
                    <div class="header-col-actions"></div>
                </div>

                <div formArrayName="centreRoles">
                    <div *ngFor="let centreRole of centreRoles.controls; let i = index" [formGroupName]="i"
                        class="centre-role-row">

                        <mat-form-field class="centre-field">
                            <mat-label>Centre</mat-label>
                            <mat-select formControlName="centreId" (selectionChange)="onCentreChange(i)">
                                <mat-option *ngFor="let centre of centres()" [value]="centre.id">
                                    {{ centre.nom }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="centreRole.get('centreId')?.hasError('required')">
                                Le centre est requis
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field class="entrepot-field" *ngIf="getEntrepotsForCentre(i).length > 0">
                            <mat-label>Entrepôts</mat-label>
                            <mat-select formControlName="entrepotIds" multiple (selectionChange)="onEntrepotsChange(i)">
                                <mat-select-trigger>
                                    {{ (centreRole.get('entrepotIds')?.value?.length || 0) + ' sélectionné(s)' }}
                                </mat-select-trigger>
                                <mat-option *ngFor="let entrepot of getEntrepotsForCentre(i)" [value]="entrepot.id">
                                    {{ entrepot.nom }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <div class="entrepot-field" *ngIf="getEntrepotsForCentre(i).length === 0">
                            <!-- Spacer or message -->
                        </div>

                        <mat-form-field class="role-field">
                            <mat-label>Rôle</mat-label>
                            <mat-select formControlName="role">
                                <mat-option *ngFor="let role of userRoles" [value]="role">
                                    {{ role }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="centreRole.get('role')?.hasError('required')">
                                Le rôle est requis
                            </mat-error>
                        </mat-form-field>

                        <button mat-icon-button type="button" color="warn" (click)="removeCentreRole(i)"
                            [disabled]="centreRoles.length === 1" matTooltip="Supprimer">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button mat-stroked-button type="button" color="primary" (click)="addCentreRole()">
                        <mat-icon>add</mat-icon>
                        Ajouter un rôle
                    </button>

                    <div class="flex gap-4">
                        <button mat-button type="button" (click)="onCancel()">Annuler</button>
                        <button mat-raised-button color="primary" type="submit">
                            {{ isEditMode ? 'Mettre à jour' : 'Enregistrer' }}
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </form>
</div>