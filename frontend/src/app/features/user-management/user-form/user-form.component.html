<div class="user-form-container p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold m-0">
            {{ isEditMode ? 'Modifier l\'utilisateur' : 'Ajouter un utilisateur' }}
        </h1>
        <button mat-icon-button (click)="onCancel()" matTooltip="Retour">
            <mat-icon>arrow_back</mat-icon>
        </button>
    </div>

    <!-- Form -->
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
        <mat-card class="form-card mb-4">
            <mat-card-content>
                <div class="main-info-grid">
                    <div class="fields-column">
                        <!-- Status Section -->
                        <div class="status-section-compact mb-4">
                            <label class="section-label">Statut</label>
                            <div class="status-checkbox-group">
                                <mat-checkbox [checked]="isStatusSelected('actif')" (change)="toggleStatus('actif')">
                                    Actif
                                </mat-checkbox>
                                <mat-checkbox [checked]="isStatusSelected('inactif')"
                                    (change)="toggleStatus('inactif')">
                                    Inactif
                                </mat-checkbox>
                            </div>
                        </div>

                        <!-- Row 1: Civilité, Nom, Prénom -->
                        <!-- Employee Selection -->
                        <div class="mb-6">
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Sélectionner le personnel</mat-label>
                                <mat-select formControlName="employeeId"
                                    (selectionChange)="onEmployeeChange($event.value)">
                                    <mat-option *ngFor="let emp of employees()" [value]="emp.id">
                                        {{ emp.nom }} {{ emp.prenom }} ({{ emp.matricule || 'N/A' }})
                                    </mat-option>
                                </mat-select>
                                <mat-error *ngIf="userForm.get('employeeId')?.hasError('required')">
                                    Veuillez sélectionner un membre du personnel
                                </mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Read-Only Preview of Selected Employee -->
                        <div *ngIf="selectedEmployee" class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                            <div class="flex items-start gap-4">
                                <img *ngIf="selectedEmployee.photoUrl" [src]="selectedEmployee.photoUrl"
                                    class="w-16 h-16 rounded-full object-cover border">
                                <div *ngIf="!selectedEmployee.photoUrl"
                                    class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-400">
                                    <mat-icon>person</mat-icon>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">{{ selectedEmployee.nom }} {{
                                        selectedEmployee.prenom }}</h3>
                                    <p class="text-sm text-gray-600">{{ selectedEmployee.email }}</p>
                                    <p class="text-sm text-gray-500">Tel: {{ selectedEmployee.telephone }}</p>
                                    <p class="text-xs text-gray-400 mt-1">Matricule: {{ selectedEmployee.matricule }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Fields for Backend Compatibility (Visually hidden but present in form) -->
                        <div class="hidden">
                            <!-- Inputs are bound via formControlName, no need to render them if we patchValue -->
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Centre-Role Associations -->
        <mat-card class="form-card mb-4">
            <mat-card-header>
                <mat-card-title>Centres et Rôles</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="centre-roles-header">
                    <div class="header-col">Centre</div>
                    <div class="header-col">Entrepôts</div>
                    <div class="header-col">Rôle</div>
                    <div class="header-col-actions"></div>
                </div>

                <div formArrayName="centreRoles">
                    <div *ngFor="let centreRole of centreRoles.controls; let i = index" [formGroupName]="i"
                        class="centre-role-row">

                        <mat-form-field class="centre-field">
                            <mat-label>Centre</mat-label>
                            <mat-select formControlName="centreId" (selectionChange)="onCentreChange(i)">
                                <mat-option *ngFor="let centre of centres()" [value]="centre.id">
                                    {{ centre.nom }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="centreRole.get('centreId')?.hasError('required')">
                                Le centre est requis
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field class="entrepot-field" *ngIf="getEntrepotsForCentre(i).length > 0">
                            <mat-label>Entrepôts</mat-label>
                            <mat-select formControlName="entrepotIds" multiple (selectionChange)="onEntrepotsChange(i)">
                                <mat-select-trigger>
                                    {{ (centreRole.get('entrepotIds')?.value?.length || 0) + ' sélectionné(s)' }}
                                </mat-select-trigger>
                                <mat-option *ngFor="let entrepot of getEntrepotsForCentre(i)" [value]="entrepot.id">
                                    {{ entrepot.nom }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <div class="entrepot-field" *ngIf="getEntrepotsForCentre(i).length === 0">
                            <!-- Spacer or message -->
                        </div>

                        <mat-form-field class="role-field">
                            <mat-label>Rôle</mat-label>
                            <mat-select formControlName="role">
                                <mat-option *ngFor="let role of userRoles" [value]="role">
                                    {{ role }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="centreRole.get('role')?.hasError('required')">
                                Le rôle est requis
                            </mat-error>
                        </mat-form-field>

                        <button mat-icon-button type="button" color="warn" (click)="removeCentreRole(i)"
                            [disabled]="centreRoles.length === 1" matTooltip="Supprimer">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                    <button mat-stroked-button type="button" color="primary" (click)="addCentreRole()">
                        <mat-icon>add</mat-icon>
                        Ajouter un rôle
                    </button>

                    <div class="flex gap-4">
                        <button mat-button type="button" (click)="onCancel()">Annuler</button>
                        <button mat-raised-button color="primary" type="submit">
                            {{ isEditMode ? 'Mettre à jour' : 'Enregistrer' }}
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </form>
</div>