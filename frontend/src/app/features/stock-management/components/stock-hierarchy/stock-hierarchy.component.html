<div class="hierarchy-container">
    <div class="header">
        <h1>Vue Hiérarchique du Stock</h1>
        <div class="actions">
            <!-- Add global actions here if needed -->
            <button mat-stroked-button color="primary" routerLink="/p/stock">
                <mat-icon>list</mat-icon>
                Vue Liste Produits
            </button>
        </div>
    </div>

    <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

    <mat-card class="tree-card">
        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="stock-tree">

            <!-- Leaf Node (Warehouse) -->
            <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
                <div class="tree-node-content warehouse-node" (click)="onNodeClick(node)">
                    <mat-icon [class]="node.type.toLowerCase() + '-icon'">
                        {{ getIcon(node.type) }}
                    </mat-icon>
                    <span class="node-name">{{ node.name }}</span>
                    <span class="node-type-label">{{ node.data.type }}</span> <!-- Display warehouse type -->

                    <button mat-icon-button class="action-btn" matTooltip="Voir détails">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>
            </mat-tree-node>

            <!-- Nested Node (Group / Center) -->
            <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
                <div class="mat-tree-node-content group-node" (click)="onNodeClick(node)">
                    <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + node.name"
                        (click)="$event.stopPropagation(); node.type === 'GROUP' || node.type === 'CENTER' ? onNodeClick(node) : null">
                        <mat-icon class="mat-icon-rtl-mirror">
                            {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                        </mat-icon>
                    </button>

                    <mat-icon [class]="node.type.toLowerCase() + '-icon'">
                        {{ getIcon(node.type) }}
                    </mat-icon>
                    <span class="node-name">{{ node.name }}</span>

                    <!-- Helper text for node count if useful -->
                    <span class="count-badge" *ngIf="node.children?.length">
                        {{ node.children.length }} {{ node.type === 'GROUP' ? 'Centres' : 'Entrepôts' }}
                    </span>
                </div>
                <div [class.tree-invisible]="!treeControl.isExpanded(node)" role="group">
                    <ng-container matTreeNodeOutlet></ng-container>
                </div>
            </mat-nested-tree-node>

        </mat-tree>

        <div *ngIf="!loading && dataSource.data.length === 0" class="no-data">
            <p>Aucune structure détectée.</p>
        </div>
    </mat-card>
</div>