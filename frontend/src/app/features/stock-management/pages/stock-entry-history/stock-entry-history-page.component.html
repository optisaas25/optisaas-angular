<div class="page-container fadeIn">
    <!-- Header Page -->
    <div class="header-section">
        <div class="title-container">
            <div class="icon-box">
                <mat-icon>history</mat-icon>
            </div>
            <div class="titles">
                <h1>Historique des Mouvements</h1>
                <p>Consultez et gérez les flux de stock passés</p>
            </div>
        </div>
        <div class="header-actions">
            <button mat-flat-button class="refresh-btn" (click)="refresh()" [disabled]="loading">
                <mat-icon [class.spinner]="loading">refresh</mat-icon>
                ACTUALISER
            </button>
        </div>
    </div>

    <mat-tab-group (selectedTabChange)="onTabChange($event)" class="modern-tabs">
        <!-- TAB: ENTRIES -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon class="tab-icon">input</mat-icon>
                <span>Entrées / Réceptions</span>
            </ng-template>

            <div class="tab-content">
                <!-- Statistics Section -->
                <div class="stats-row">
                    <mat-card class="stats-card entries">
                        <div class="stats-icon">
                            <mat-icon>description</mat-icon>
                        </div>
                        <div class="stats-info">
                            <span class="label">TOTAL DOCUMENTS</span>
                            <span class="value">{{ stats.totalEntries }}</span>
                        </div>
                    </mat-card>

                    <mat-card class="stats-card items">
                        <div class="stats-icon">
                            <mat-icon>shopping_basket</mat-icon>
                        </div>
                        <div class="stats-info">
                            <span class="label">ARTICLES RÉCEPTIONNÉS</span>
                            <span class="value">{{ stats.totalItems }}</span>
                        </div>
                    </mat-card>

                    <mat-card class="stats-card value">
                        <div class="stats-icon">
                            <mat-icon>payments</mat-icon>
                        </div>
                        <div class="stats-info">
                            <span class="label">VALEUR TOTALE (TTC)</span>
                            <span class="value">{{ stats.totalValue | number:'1.2-2' }} DH</span>
                        </div>
                    </mat-card>
                </div>

                <!-- Filters Section -->
                <mat-card class="filters-card">
                    <div class="card-header">
                        <mat-icon>filter_list</mat-icon>
                        <h3>CRITÈRES DE RECHERCHE</h3>
                    </div>
                    <form [formGroup]="filterForm" class="filters-grid">
                        <div class="filter-item">
                            <label>Période</label>
                            <div class="date-range-picker">
                                <mat-form-field appearance="outline" class="compact-field">
                                    <mat-date-range-input [rangePicker]="picker">
                                        <input matStartDate formControlName="dateFrom" placeholder="Début">
                                        <input matEndDate formControlName="dateTo" placeholder="Fin">
                                    </mat-date-range-input>
                                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                                    <mat-date-range-picker #picker></mat-date-range-picker>
                                </mat-form-field>
                                <button mat-icon-button [matMenuTriggerFor]="dateMenu" matTooltip="Raccourcis"
                                    class="period-btn">
                                    <mat-icon>calendar_today</mat-icon>
                                </button>
                                <mat-menu #dateMenu="matMenu" class="modern-menu">
                                    <button mat-menu-item (click)="setPeriod('TODAY')">Aujourd'hui</button>
                                    <button mat-menu-item (click)="setPeriod('YESTERDAY')">Hier</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_WEEK')">Cette semaine</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_MONTH')">Ce mois-ci</button>
                                    <button mat-menu-item (click)="setPeriod('LAST_MONTH')">Le mois dernier</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_YEAR')">Cette année</button>
                                </mat-menu>
                            </div>
                        </div>

                        <mat-form-field appearance="outline" class="compact-field">
                            <mat-label>Type Document</mat-label>
                            <mat-select formControlName="docType">
                                <mat-option [value]="null">Tous les documents</mat-option>
                                <mat-option value="FACTURE">Factures</mat-option>
                                <mat-option value="BL">Bons de Livraison (BL)</mat-option>
                            </mat-select>
                            <mat-icon matPrefix>file_present</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="compact-field">
                            <mat-label>Fournisseur</mat-label>
                            <mat-select formControlName="supplierId">
                                <mat-option [value]="null">Tous les fournisseurs</mat-option>
                                <mat-option *ngFor="let s of suppliers" [value]="s.id">{{ s.nom }}</mat-option>
                            </mat-select>
                            <mat-icon matPrefix>storefront</mat-icon>
                        </mat-form-field>

                        <div class="filter-actions">
                            <button mat-button (click)="resetFilters()" class="reset-btn">
                                <mat-icon>restart_alt</mat-icon>
                                RÉINIT.
                            </button>
                            <button mat-raised-button color="primary" (click)="loadHistory()" class="apply-btn">
                                <mat-icon>search</mat-icon>
                                FILTRER
                            </button>
                        </div>
                    </form>
                </mat-card>

                <!-- Entries Table Section -->
                <div class="table-container shadow-sm">
                    <div class="loading-overlay" *ngIf="loading">
                        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
                    </div>

                    <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="premium-table">
                        <ng-container matColumnDef="dateEmission">
                            <th mat-header-cell *matHeaderCellDef> Date </th>
                            <td mat-cell *matCellDef="let element"> {{ element.dateEmission | date:'dd/MM/yyyy' }} </td>
                        </ng-container>

                        <ng-container matColumnDef="fournisseur">
                            <th mat-header-cell *matHeaderCellDef> Fournisseur </th>
                            <td mat-cell *matCellDef="let element" class="font-bold"> {{ element.fournisseur?.nom }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="numeroFacture">
                            <th mat-header-cell *matHeaderCellDef> N° Pièce </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="badge"
                                    [class.badge-facture]="element.type === 'FACTURE' || element.type === 'ACHAT_STOCK'"
                                    [class.badge-bl]="element.type === 'BL'">
                                    {{ element.type === 'BL' ? 'BL' : 'FACT' }}
                                </span>
                                {{ element.numeroFacture }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="montantTTC">
                            <th mat-header-cell *matHeaderCellDef> Montant TTC </th>
                            <td mat-cell *matCellDef="let element" class="text-primary font-bold"> {{ element.montantTTC
                                | number:'1.2-2' }} DH </td>
                        </ng-container>

                        <ng-container matColumnDef="itemsCount">
                            <th mat-header-cell *matHeaderCellDef> Articles </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="count-badge">
                                    {{ element.itemsCount }} réf. ({{ element.totalAllocated }})
                                </span>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> </th>
                            <td mat-cell *matCellDef="let element">
                                <button mat-icon-button color="warn"
                                    (click)="deleteEntry(element); $event.stopPropagation()"
                                    matTooltip="Supprimer l'historique">
                                    <mat-icon>delete_outline</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="expand">
                            <th mat-header-cell *matHeaderCellDef> </th>
                            <td mat-cell *matCellDef="let element">
                                <mat-icon translate="no">{{ expandedElement === element ? 'expand_less' : 'expand_more'
                                    }}</mat-icon>
                            </td>
                        </ng-container>

                        <!-- Expanded Content Column -->
                        <ng-container matColumnDef="expandedDetail">
                            <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
                                <div class="element-detail"
                                    [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'">
                                    <div class="expanded-grid">
                                        <div class="detail-section">
                                            <h4>Détails Document</h4>
                                            <div class="detail-info">
                                                <p><span>Créé le:</span> {{ element.createdAt | date:'dd/MM HH:mm' }}
                                                </p>
                                                <p *ngIf="element.pieceJointeUrl">
                                                    <span>Justificatif:</span>
                                                    <a [href]="getAttachmentUrl(element.pieceJointeUrl)" target="_blank"
                                                        class="link-btn">
                                                        <mat-icon>attach_file</mat-icon> Voir le fichier
                                                    </a>
                                                </p>
                                            </div>
                                            <div class="warehouse-distribution mt-4">
                                                <h4>Répartition Entrepôts</h4>
                                                <div class="chips-container">
                                                    <div class="chip" *ngFor="let w of getWarehouseSummary(element)">
                                                        <span class="chip-name">{{ w.name }}</span>
                                                        <span class="chip-count">{{ w.count }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="products-section">
                                            <h4>Produits Réceptionnés</h4>
                                            <div class="mini-table-wrapper">
                                                <table class="mini-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Produit</th>
                                                            <th>Entrepôt</th>
                                                            <th>Quantité</th>
                                                            <th>PA HT</th>
                                                            <th>PV TTC</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr *ngFor="let m of element.mouvementsStock">
                                                            <td>
                                                                <div class="prod-desc">
                                                                    <span class="prod-name">{{ m.produit?.designation
                                                                        }}</span>
                                                                    <span class="prod-ref">{{ m.produit?.codeInterne
                                                                        }}</span>
                                                                </div>
                                                            </td>
                                                            <td>{{ m.entrepotDestination?.nom }}</td>
                                                            <td class="font-bold">+ {{ m.quantite }}</td>
                                                            <td>{{ m.prixAchatUnitaire | number:'1.2-2' }}</td>
                                                            <td>{{ m.produit?.prixVenteTTC | number:'1.2-2' }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
                        <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" class="element-row"
                            [class.expanded-row]="expandedElement === element"
                            (click)="expandedElement = expandedElement === element ? null : element"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

                        <tr class="mat-row empty-row" *matNoDataRow>
                            <td class="mat-cell" [attr.colspan]="columnsToDisplay.length">
                                <div class="empty-state">
                                    <mat-icon>history_toggle_off</mat-icon>
                                    <p>Aucun historique d'entrée trouvé pour ces critères.</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </mat-tab>

        <!-- TAB: OUTS -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon class="tab-icon">output</mat-icon>
                <span>Sorties / Transferts</span>
            </ng-template>

            <div class="tab-content">
                <!-- Statistics Section -->
                <div class="stats-row">
                    <mat-card class="stats-card sorties">
                        <div class="stats-icon">
                            <mat-icon>remove_shopping_cart</mat-icon>
                        </div>
                        <div class="stats-info">
                            <span class="label">TOTAL OPÉRATIONS</span>
                            <span class="value">{{ outStats.totalSorties }}</span>
                        </div>
                    </mat-card>

                    <mat-card class="stats-card items">
                        <div class="stats-icon">
                            <mat-icon>inventory_2</mat-icon>
                        </div>
                        <div class="stats-info">
                            <span class="label">ARTICLES RETIRÉS</span>
                            <span class="value">{{ outStats.totalItems }}</span>
                        </div>
                    </mat-card>
                </div>

                <!-- Filters Section -->
                <mat-card class="filters-card">
                    <div class="card-header">
                        <mat-icon>search</mat-icon>
                        <h3>FILTRER LES SORTIES</h3>
                    </div>
                    <form [formGroup]="outFilterForm" class="filters-grid">
                        <div class="filter-item">
                            <label>Période</label>
                            <div class="date-range-picker">
                                <mat-form-field appearance="outline" class="compact-field">
                                    <mat-date-range-input [rangePicker]="outPicker">
                                        <input matStartDate formControlName="dateFrom" placeholder="Début">
                                        <input matEndDate formControlName="dateTo" placeholder="Fin">
                                    </mat-date-range-input>
                                    <mat-datepicker-toggle matIconSuffix [for]="outPicker"></mat-datepicker-toggle>
                                    <mat-date-range-picker #outPicker></mat-date-range-picker>
                                </mat-form-field>
                                <button mat-icon-button [matMenuTriggerFor]="outDateMenu" matTooltip="Raccourcis"
                                    class="period-btn">
                                    <mat-icon>calendar_today</mat-icon>
                                </button>
                                <mat-menu #outDateMenu="matMenu" class="modern-menu">
                                    <button mat-menu-item (click)="setPeriod('TODAY')">Aujourd'hui</button>
                                    <button mat-menu-item (click)="setPeriod('YESTERDAY')">Hier</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_WEEK')">Cette semaine</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_MONTH')">Ce mois-ci</button>
                                    <button mat-menu-item (click)="setPeriod('LAST_MONTH')">Le mois dernier</button>
                                    <button mat-menu-item (click)="setPeriod('THIS_YEAR')">Cette année</button>
                                </mat-menu>
                            </div>
                        </div>

                        <mat-form-field appearance="outline" class="compact-field">
                            <mat-label>Rechercher (Motif, Produit...)</mat-label>
                            <input matInput formControlName="search" placeholder="Ex: Ajustement, Casse...">
                            <mat-icon matPrefix>search</mat-icon>
                        </mat-form-field>

                        <div class="filter-actions">
                            <button mat-button (click)="resetOutFilters()" class="reset-btn">
                                <mat-icon>restart_alt</mat-icon>
                                RÉINIT.
                            </button>
                            <button mat-raised-button color="primary" (click)="loadOutHistory()" class="apply-btn">
                                <mat-icon>search</mat-icon>
                                FILTRER
                            </button>
                        </div>
                    </form>
                </mat-card>

                <!-- Sorties Table Section -->
                <div class="table-container shadow-sm">
                    <div class="loading-overlay" *ngIf="loading">
                        <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
                    </div>

                    <table mat-table [dataSource]="outDataSource" multiTemplateDataRows class="premium-table">
                        <ng-container matColumnDef="dateMovement">
                            <th mat-header-cell *matHeaderCellDef> Date </th>
                            <td mat-cell *matCellDef="let element"> {{ element.dateMovement | date:'dd/MM/yyyy HH:mm' }}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="motif">
                            <th mat-header-cell *matHeaderCellDef> Motif / Justification </th>
                            <td mat-cell *matCellDef="let element" class="font-bold"> {{ element.motif }} </td>
                        </ng-container>

                        <ng-container matColumnDef="utilisateur">
                            <th mat-header-cell *matHeaderCellDef> Utilisateur </th>
                            <td mat-cell *matCellDef="let element"> {{ element.utilisateur }} </td>
                        </ng-container>

                        <ng-container matColumnDef="itemsCount">
                            <th mat-header-cell *matHeaderCellDef> Articles </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="count-badge red">
                                    {{ element.itemsCount }} produit(s)
                                </span>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="expand">
                            <th mat-header-cell *matHeaderCellDef> </th>
                            <td mat-cell *matCellDef="let element">
                                <mat-icon translate="no">{{ expandedElement === element ? 'expand_less' : 'expand_more'
                                    }}</mat-icon>
                            </td>
                        </ng-container>

                        <!-- Expanded Content Column -->
                        <ng-container matColumnDef="expandedDetail">
                            <td mat-cell *matCellDef="let element" [attr.colspan]="outColumnsToDisplay.length">
                                <div class="element-detail"
                                    [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'">
                                    <div class="products-section full-width">
                                        <h4>Détails des Articles</h4>
                                        <div class="mini-table-wrapper">
                                            <table class="mini-table out-table">
                                                <thead>
                                                    <tr>
                                                        <th>Produit</th>
                                                        <th>Centre / Entrepôts</th>
                                                        <th>Client / Contexte</th>
                                                        <th>Quantité</th>
                                                        <th>Type</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let m of element.mouvementsStock">
                                                        <td>
                                                            <div class="prod-desc">
                                                                <span class="prod-name">{{ m.produit?.designation
                                                                    }}</span>
                                                                <span class="prod-ref">{{ m.produit?.codeInterne
                                                                    }}</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="center-info">
                                                                <span class="center-name"
                                                                    *ngIf="m.entrepotSource?.centre?.nom">
                                                                    {{ m.entrepotSource.centre.nom }}
                                                                </span>
                                                                <div class="warehouse-path">
                                                                    <span class="source" *ngIf="m.entrepotSource">{{
                                                                        m.entrepotSource.nom }}</span>
                                                                    <mat-icon
                                                                        *ngIf="m.entrepotSource && m.entrepotDestination">arrow_forward</mat-icon>
                                                                    <span class="dest" *ngIf="m.entrepotDestination">{{
                                                                        m.entrepotDestination.nom }}</span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="client-info">
                                                                <span class="client-name"
                                                                    *ngIf="m.facture?.client?.nom; else noClient">
                                                                    <mat-icon>person</mat-icon> {{ m.facture.client.nom
                                                                    }} {{ m.facture.client.prenom }}
                                                                </span>
                                                                <ng-template #noClient>
                                                                    <span class="motif-text">{{ m.motif }}</span>
                                                                </ng-template>
                                                            </div>
                                                        </td>
                                                        <td class="font-bold"
                                                            [class.text-red-600]="m.type !== 'TRANSFERT_ENTREE' && m.type !== 'RECEPTION'"
                                                            [class.text-green-600]="m.type === 'TRANSFERT_ENTREE' || m.type === 'RECEPTION'">
                                                            {{ (m.type === 'TRANSFERT_ENTREE' || m.type === 'RECEPTION')
                                                            ? '+' : '-' }} {{ m.quantite }}
                                                        </td>
                                                        <td>
                                                            <span class="type-indicator" [class]="m.type.toLowerCase()">
                                                                {{ m.type }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="outColumnsToDisplay"></tr>
                        <tr mat-row *matRowDef="let element; columns: outColumnsToDisplay;" class="element-row"
                            [class.expanded-row]="expandedElement === element"
                            (click)="expandedElement = expandedElement === element ? null : element"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>

                        <tr class="mat-row empty-row" *matNoDataRow>
                            <td class="mat-cell" [attr.colspan]="outColumnsToDisplay.length">
                                <div class="empty-state">
                                    <mat-icon>remove_shopping_cart</mat-icon>
                                    <p>Aucun historique de sortie trouvé.</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>