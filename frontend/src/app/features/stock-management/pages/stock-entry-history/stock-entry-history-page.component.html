<div class="page-container">
    <div class="page-header">
        <h2>Historique des Entrées de Stock</h2>
        <div class="header-actions">
            <button mat-icon-button (click)="loadHistory()" matTooltip="Actualiser">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>
    </div>

    <div class="filters-section" [formGroup]="filterForm">

        <!-- Date Filter with Shortcuts -->
        <div class="date-filter-group">
            <button mat-icon-button [matMenuTriggerFor]="dateMenu" matTooltip="Périodes prédéfinies">
                <mat-icon>calendar_today</mat-icon>
            </button>
            <mat-menu #dateMenu="matMenu">
                <button mat-menu-item (click)="setPeriod('TODAY')">Aujourd'hui</button>
                <button mat-menu-item (click)="setPeriod('YESTERDAY')">Hier</button>
                <button mat-menu-item (click)="setPeriod('THIS_WEEK')">Cette semaine</button>
                <button mat-menu-item (click)="setPeriod('THIS_MONTH')">Ce mois</button>
                <button mat-menu-item (click)="setPeriod('LAST_MONTH')">Mois dernier</button>
                <button mat-menu-item (click)="setPeriod('THIS_YEAR')">Cette année</button>
            </mat-menu>

            <mat-form-field appearance="outline" class="dense-field date-field">
                <mat-label>Période</mat-label>
                <mat-date-range-input [rangePicker]="picker">
                    <input matStartDate formControlName="dateFrom" placeholder="Début">
                    <input matEndDate formControlName="dateTo" placeholder="Fin">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>
        </div>

        <!-- Document Type Filter -->
        <mat-form-field appearance="outline" class="dense-field">
            <mat-label>Type Document</mat-label>
            <mat-select formControlName="docType">
                <mat-option [value]="null">Tous</mat-option>
                <mat-option value="FACTURE">Facture</mat-option>
                <mat-option value="BL">Bon de Livraison</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Supplier Filter -->
        <mat-form-field appearance="outline" class="dense-field">
            <mat-label>Fournisseur</mat-label>
            <mat-select formControlName="supplierId">
                <mat-option [value]="null">Tous</mat-option>
                <mat-option *ngFor="let s of suppliers" [value]="s.id">{{ s.nom }}</mat-option>
            </mat-select>
        </mat-form-field>

        <button mat-flat-button color="primary" (click)="loadHistory()">
            <mat-icon>search</mat-icon> Filtrer
        </button>
        <button mat-stroked-button (click)="resetFilters()">
            Réinitialiser
        </button>
    </div>

    <div class="page-content">
        <div class="loading-container" *ngIf="loading">
            <mat-spinner diameter="40"></mat-spinner>
        </div>

        <div class="table-container" *ngIf="!loading">
            <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="history-table">

                <!-- Date Column -->
                <ng-container matColumnDef="dateEmission">
                    <th mat-header-cell *matHeaderCellDef> Date </th>
                    <td mat-cell *matCellDef="let element"> {{element.dateEmission | date:'dd/MM/yyyy HH:mm'}} </td>
                </ng-container>

                <!-- Supplier Column -->
                <ng-container matColumnDef="fournisseur">
                    <th mat-header-cell *matHeaderCellDef> Fournisseur </th>
                    <td mat-cell *matCellDef="let element"> {{element.fournisseur?.nom}} </td>
                </ng-container>

                <!-- Invoice Number Column -->
                <ng-container matColumnDef="numeroFacture">
                    <th mat-header-cell *matHeaderCellDef> N° Pièce </th>
                    <td mat-cell *matCellDef="let element">
                        <span class="font-medium">{{element.numeroFacture}}</span>
                        <span class="text-xs text-gray-500 ml-1">({{element.type}})</span>
                    </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="montantTTC">
                    <th mat-header-cell *matHeaderCellDef> Montant TTC </th>
                    <td mat-cell *matCellDef="let element">
                        {{element.montantTTC | number:'1.2-2'}} DH
                    </td>
                </ng-container>

                <!-- Items Count Column -->
                <ng-container matColumnDef="itemsCount">
                    <th mat-header-cell *matHeaderCellDef> Articles </th>
                    <td mat-cell *matCellDef="let element">
                        <span class="badge">{{element.itemsCount}}</span>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> </th>
                    <td mat-cell *matCellDef="let element">
                        <button mat-icon-button color="warn" matTooltip="Supprimer l'entrée"
                            (click)="deleteEntry(element); $event.stopPropagation()">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <!-- Expand Column -->
                <ng-container matColumnDef="expand">
                    <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
                    <td mat-cell *matCellDef="let element">
                        <button mat-icon-button aria-label="expand row"
                            (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
                            <mat-icon *ngIf="expandedElement !== element">keyboard_arrow_down</mat-icon>
                            <mat-icon *ngIf="expandedElement === element">keyboard_arrow_up</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <!-- Expanded Content Column - The detail row -->
                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
                        <div class="element-detail"
                            [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">

                            <div class="detail-container">
                                <div class="detail-header">
                                    <div class="detail-info">
                                        <div class="info-item">
                                            <span class="label">Date création:</span>
                                            <span class="value">{{element.createdAt | date:'short'}}</span>
                                        </div>
                                        <div class="info-item" *ngIf="element.pieceJointeUrl">
                                            <span class="label">Pièce jointe:</span>
                                            <a [href]="getAttachmentUrl(element.pieceJointeUrl)" target="_blank"
                                                class="link-download">
                                                <mat-icon class="text-sm">visibility</mat-icon> Visualiser / Enregistrer
                                            </a>
                                        </div>
                                    </div>

                                    <div class="warehouse-summary">
                                        <h4>Répartition par entrepôt</h4>
                                        <div class="summary-chips">
                                            <span class="chip" *ngFor="let w of getWarehouseSummary(element)">
                                                {{w.name}}: <strong>{{w.count}}</strong>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="products-list">
                                    <h4>Liste des produits inclus</h4>
                                    <table class="mini-table">
                                        <thead>
                                            <tr>
                                                <th>Référence</th>
                                                <th>Désignation</th>
                                                <th>Entrepôt</th>
                                                <th>Qte</th>
                                                <th>P.Achat</th>
                                                <th>P.Vente</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let item of element.mouvementsStock">
                                                <td>{{item.produit?.codeInterne}}</td>
                                                <td>{{item.produit?.designation}}</td>
                                                <td>{{item.entrepotDestination?.nom}}</td>
                                                <td class="text-center font-bold">{{item.quantite}}</td>
                                                <td class="text-right">{{item.prixAchatUnitaire | number:'1.2-2'}}</td>
                                                <td class="text-right">{{item.prixVenteUnitaire | number:'1.2-2'}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
                <tr mat-row *matRowDef="let element; columns: columnsToDisplay;" class="element-row"
                    [class.expanded-row]="expandedElement === element"
                    (click)="expandedElement = expandedElement === element ? null : element">
                </tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
            </table>
        </div>
    </div>
</div>