generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                  String          @id @default(uuid())
  typeClient          String
  dateCreation        DateTime        @default(now())
  email               String?
  telephone           String?
  adresse             String?
  ville               String?
  codePostal          String?
  pointsFidelite      Int             @default(0)
  statut              String          @default("INACTIF")
  commentaires        String?
  titre               String?
  nom                 String?
  prenom              String?
  dateNaissance       DateTime?
  typePieceIdentite   String?
  numeroPieceIdentite String?
  cinParent           String?
  groupeFamille       Json?
  dossierMedical      Json?
  couvertureSociale   Json?
  raisonSociale       String?
  identifiantFiscal   String?
  ice                 String?
  registreCommerce    String?
  patente             String?
  tvaAssujetti        Boolean?        @default(false)
  numeroAutorisation  String?
  siteWeb             String?
  contacts            Json?
  convention          Json?
  parrainId           String?
  centreId            String?
  centre              Centre?         @relation(fields: [centreId], references: [id])
  parrain             Client?         @relation("Parrainage", fields: [parrainId], references: [id])
  filleuls            Client[]        @relation("Parrainage")
  factures            Facture[]
  fiches              Fiche[]
  pointsHistory       PointsHistory[]
  rewardRedemptions   RewardRedemption[]
}

model Fiche {
  id                   String    @id @default(uuid())
  dateCreation         DateTime  @default(now())
  statut               String
  type                 String
  dateLivraisonEstimee DateTime?
  montantTotal         Float     @default(0)
  montantPaye          Float     @default(0)
  clientId             String
  content              Json
  facture              Facture?
  client               Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Facture {
  id              String           @id @default(uuid())
  numero          String           @unique
  type            String
  dateEmission    DateTime         @default(now())
  dateEcheance    DateTime?
  statut          String
  clientId        String
  ficheId         String?          @unique
  totalHT         Float            @default(0)
  totalTVA        Float            @default(0)
  totalTTC        Float            @default(0)
  resteAPayer     Float            @default(0)
  lignes          Json
  proprietes      Json?
  parentFactureId String?
  montantLettres  String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  centreId        String?
  centre          Centre?          @relation(fields: [centreId], references: [id])
  client          Client           @relation(fields: [clientId], references: [id])
  fiche           Fiche?           @relation(fields: [ficheId], references: [id])
  parentFacture   Facture?         @relation("FactureRelations", fields: [parentFactureId], references: [id])
  children        Facture[]        @relation("FactureRelations")
  mouvementsStock MouvementStock[]
  paiements       Paiement[]
  pointsHistory   PointsHistory[]
}

model Paiement {
  id            String    @id @default(uuid())
  montant       Float
  date          DateTime  @default(now())
  mode          String
  reference     String?
  notes         String?
  dateVersement DateTime?
  banque        String?
  tiersNom      String?
  tiersCin      String?
  remarque      String?
  pieceJointe   String?
  statut        String    @default("ENCAISSE") // EN_ATTENTE, ENCAISSE, REJETE, ANNULE
  dateEncaissement DateTime?
  factureId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  facture       Facture   @relation(fields: [factureId], references: [id], onDelete: Cascade)
}

model Groupe {
  id          String   @id @default(uuid())
  nom         String   @unique
  description String?
  adresse     String?
  telephone   String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  centres     Centre[]
}

model Centre {
  id          String     @id @default(uuid())
  nom         String
  description String?
  adresse     String?
  ville       String?
  codePostal  String?
  telephone   String?
  email       String?
  groupeId    String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  groupe      Groupe     @relation(fields: [groupeId], references: [id], onDelete: Cascade)
  clients     Client[]
  entrepots   Entrepot[]
  factures    Facture[]
  depenses    Depense[]
  facturesFournisseurs FactureFournisseur[]

  @@unique([groupeId, nom])
}

model Entrepot {
  id                    String           @id @default(uuid())
  nom                   String
  description           String?
  type                  String
  capaciteMax           Float?
  surface               Float?
  responsable           String?
  centreId              String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  centre                Centre           @relation(fields: [centreId], references: [id], onDelete: Cascade)
  mouvementsDestination MouvementStock[] @relation("EntrepotDestination")
  mouvementsSource      MouvementStock[] @relation("EntrepotSource")
  produits              Product[]

  @@unique([centreId, nom])
}

model Product {
  id                   String           @id @default(uuid())
  codeInterne          String
  codeBarres           String
  referenceFournisseur String?
  designation          String
  marque               String?
  modele               String?
  couleur              String?
  typeArticle          String
  famille              String?
  sousFamille          String?
  fournisseurPrincipal String?
  quantiteActuelle     Float            @default(0)
  seuilAlerte          Float            @default(0)
  prixAchatHT          Float            @default(0)
  coefficient          Float            @default(1)
  prixVenteHT          Float            @default(0)
  prixVenteTTC         Float            @default(0)
  tauxTVA              Float            @default(0.20)
  statut               String
  photo                String?
  utilisateurCreation  String
  specificData         Json?
  entrepotId           String
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  mouvements           MouvementStock[]
  entrepot             Entrepot         @relation(fields: [entrepotId], references: [id])

  @@unique([codeInterne, entrepotId])
  @@unique([codeBarres, entrepotId])
}

model MouvementStock {
  id                    String    @id @default(uuid())
  type                  String
  quantite              Float
  dateMovement          DateTime  @default(now())
  motif                 String
  utilisateur           String
  produitId             String
  entrepotSourceId      String?
  entrepotDestinationId String?
  fournisseurId         String?
  clientId              String?
  factureId             String?
  prixAchatUnitaire     Float?
  prixVenteUnitaire     Float?
  numeroLot             String?
  datePeremption        DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  entrepotDestination   Entrepot? @relation("EntrepotDestination", fields: [entrepotDestinationId], references: [id])
  entrepotSource        Entrepot? @relation("EntrepotSource", fields: [entrepotSourceId], references: [id])
  facture               Facture?  @relation(fields: [factureId], references: [id])
  produit               Product   @relation(fields: [produitId], references: [id], onDelete: Cascade)
}

model User {
  id          String           @id @default(uuid())
  nom         String
  prenom      String
  civilite    String
  telephone   String?
  email       String           @unique
  photoUrl    String?
  matricule   String?
  statut      String           @default("actif")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  centreRoles UserCentreRole[]
}

model UserCentreRole {
  id            String   @id @default(uuid())
  userId        String
  centreId      String
  centreName    String
  role          String
  entrepotIds   String[]
  entrepotNames String[]
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, centreId])
}

model PointsHistory {
  id          String   @id @default(uuid())
  clientId    String
  points      Int
  type        String
  date        DateTime @default(now())
  description String?
  factureId   String?
  createdAt   DateTime @default(now())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  facture     Facture? @relation(fields: [factureId], references: [id])
}

model LoyaltyConfig {
  id                  String   @id @default(uuid())
  pointsPerDH         Float    @default(0.1)
  referrerBonus       Int      @default(50)
  refereeBonus        Int      @default(20)
  folderCreationBonus Int      @default(30)
  rewardThreshold     Int      @default(500)
  pointsToMADRatio    Float    @default(0.1)
  updatedAt           DateTime @updatedAt
}

model RewardRedemption {
  id          String   @id @default(uuid())
  clientId    String
  pointsUsed  Int
  rewardType  String
  madValue    Float
  redeemedAt  DateTime @default(now())
  redeemedBy  String?
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Fournisseur {
  id                  String               @id @default(uuid())
  nom                 String
  contact             String?
  email               String?
  telephone           String?
  adresse             String?
  ville               String?
  siteWeb             String?
  ice                 String?              // Identifiant Commun de l'Entreprise
  rc                  String?              // Registre du Commerce
  identifiantFiscal   String?
  patente             String?
  siret               String?
  cnss                String?
  rib                 String?
  banque              String?
  conditionsPaiement  String?              // Ex: 30 jours, 60 jours...
  contacts            Json?
  convention          Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  factures            FactureFournisseur[]
  depenses            Depense[]
}

model Depense {
  id                  String               @id @default(uuid())
  date                DateTime             @default(now())
  montant             Float
  categorie           String               // LOYER, ELECTRICITE, EAU, SALAIRE, ACHAT_marchandise, AUTRE...
  description         String?
  modePaiement        String               // ESPECES, CHEQUE, VIREMENT, CARTE, LCN
  statut              String               // BROUILLON, VALIDEE, PAYEE, ANNULEE
  justificatifUrl     String?
  reference           String?              // Numéro chèque ou LCN, ou ref carte
  dateEcheance        DateTime?            // Pour chèque et LCN
  centreId            String
  centre              Centre               @relation(fields: [centreId], references: [id])
  fournisseurId       String?
  fournisseur         Fournisseur?         @relation(fields: [fournisseurId], references: [id])
  factureFournisseurId String?             @unique
  factureFournisseur  FactureFournisseur?  @relation(fields: [factureFournisseurId], references: [id])
  echeanceId          String?              @unique
  echeance            EcheancePaiement?    @relation(fields: [echeanceId], references: [id])
  creePar             String?              // ID utilisateur
  validePar           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model FactureFournisseur {
  id               String    @id @default(uuid())
  numeroFacture    String    @unique
  dateEmission     DateTime
  dateEcheance     DateTime?
  montantHT        Float
  montantTVA       Float
  montantTTC       Float
  statut           String    @default("A_PAYER")
  type             String    @default("ACHAT_STOCK")
  fournisseurId    String
  centreId         String?   // New field
  fournisseur      Fournisseur @relation(fields: [fournisseurId], references: [id])
  centre           Centre?    @relation(fields: [centreId], references: [id])
  depenses         Depense[]
  pieceJointeUrl   String?
  echeances        EcheancePaiement[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([fournisseurId, numeroFacture])
}

model EcheancePaiement {
  id                  String               @id @default(uuid())
  reference           String?              // Numéro chèque ou LCN
  type                String               // CHEQUE, LCN, VIREMENT, ESPECES
  dateEcheance        DateTime
  dateEncaissement    DateTime?
  montant             Float
  statut              String               // EN_ATTENTE, DEPOSE, ENCAISSE, REJETE, ANNULE
  banque              String?              // Banque du magasin
  remarque            String?
  factureFournisseurId String?
  factureFournisseur  FactureFournisseur?  @relation(fields: [factureFournisseurId], references: [id])
  depense             Depense?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model FinanceConfig {
  id                  String   @id @default(uuid())
  monthlyThreshold    Float    @default(50000)
  updatedAt           DateTime @updatedAt
}
